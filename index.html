<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Hub Dashboard</title>
    <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CDN production warning for this dashboard app
    if (typeof tailwind !== 'undefined') {
      tailwind.config = { corePlugins: { preflight: false } };
    }
  </script>
    <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <style>
        /* Base styles */
    body { font-family: 'Inter', sans-serif; }
        
        /* Layout components */
        .chart-container { position: relative; height: 400px; width: 100%; }
        
        /* Interactive elements */
        .btn-toggle.active { background-color: rgb(79, 70, 229); color: white; }
        
        /* Modern, attractive tab styling */
        #topTabs {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .dark #topTabs {
            background: #1E293B;
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tab-btn {
            position: relative;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: 0.025em;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: #6B7280;
            flex: 1;
            text-align: center;
            min-width: 140px;
            cursor: pointer;
        }
        
        .tab-btn:hover {
            background-color: rgba(79, 70, 229, 0.08);
            color: #4F46E5;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: #FFFFFF;
            font-weight: 700;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        /* Dark mode tab styling */
        .dark .tab-btn {
            color: #94A3B8;
        }
        
        .dark .tab-btn:hover {
            background-color: rgba(96, 165, 250, 0.1);
            color: #60A5FA;
        }
        
        .dark .tab-btn.active {
            background: linear-gradient(135deg, #5B21B6 0%, #7C2D12 100%);
            color: #FFFFFF;
            font-weight: 700;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }
        
        /* Modal styles */
        #agentModal { display: none; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-content-enter { animation: slideUp 0.4s ease-out; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Simple loading animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes particleOrbit {
            0% { transform: rotate(0deg) translateX(35px) rotate(0deg); opacity: 1; }
            25% { opacity: 0.7; }
            50% { opacity: 1; }
            75% { opacity: 0.7; }
            100% { transform: rotate(360deg) translateX(35px) rotate(-360deg); opacity: 1; }
        }
        
        /* Simple loader structure */
        .simple-loader {
            position: relative;
            width: 60px;
            height: 60px;
        }
        
        .loader-circle {
            width: 60px;
            height: 60px;
            border: 3px solid #E5E7EB;
            border-top: 3px solid #4F46E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: particleOrbit 3s linear infinite;
        }
        
        .loader-particle:nth-child(1) { background: #4F46E5; animation-delay: 0s; }
        .loader-particle:nth-child(2) { background: #06B6D4; animation-delay: -0.75s; }
        .loader-particle:nth-child(3) { background: #10B981; animation-delay: -1.5s; }
        .loader-particle:nth-child(4) { background: #F59E0B; animation-delay: -2.25s; }
        
        /* Force absolute centering for loader */
        #loader {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999 !important;
            background-color: #FFFFFF !important;
        }
        
        /* Dark mode loader background */
        .dark #loader {
            background-color: #0F172A !important;
        }
        
        /* Hide loader when loading is complete */
        #loader.hidden {
            display: none !important;
        }
        
        /* Brand wordmark loader (official SVG image) */
        .brand-loader { position: relative; width: min(420px, 80vw); isolation: isolate; }
        .brand-logo { position: relative; z-index: 0; width: 100%; height: auto; animation: brand-bob 2.4s ease-in-out infinite; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.28)); }
        /* Subtle vector stroke around inline SVG shapes */
        .brand-logo path,
        .brand-logo circle,
        .brand-logo rect,
        .brand-logo polygon,
        .brand-logo polyline,
        .brand-logo ellipse,
        .brand-logo text { stroke: rgba(0,0,0,0.66); stroke-width: 1.6; vector-effect: non-scaling-stroke; paint-order: stroke; }
        .brand-loader::after { content: none; }
        .brand-logo .shineOverlay { opacity: 0.12; }
        .dark .brand-logo .shineOverlay { display: none; }
        @keyframes brand-bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes octopus-blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
        @keyframes tentacle-wave { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(5deg); } }
        
        /* Cute octopus animations */
        .brand-logo ellipse[cx="175"][cy="100"], 
        .brand-logo ellipse[cx="225"][cy="100"] { 
            animation: octopus-blink 3s ease-in-out infinite; 
            transform-origin: center; 
        }
        .brand-logo ellipse[cx="150"], 
        .brand-logo ellipse[cx="250"] { 
            animation: tentacle-wave 2s ease-in-out infinite alternate; 
            transform-origin: center top; 
        }
        @keyframes brand-shine { 0% { transform: translateX(-120%); } 60% { transform: translateX(140%); } 100% { transform: translateX(140%); } }

        /* Octopus loader */
        :root { --octo-color: #4F46E5; }
        .octo-loader { width: 96px; height: 96px; display: block; }
        .octo { animation: octo-bob 2.2s ease-in-out infinite; transform-origin: 48px 48px; }
        .octo-head { fill: var(--octo-color); }
        .octo-eye { fill: #FFFFFF; }
        .octo-tentacle { stroke: var(--octo-color); fill: none; stroke-width: 4; stroke-linecap: round; stroke-dasharray: 28 14; animation: octo-dash 1.6s linear infinite; }
        .octo-t1 { animation-delay: 0s; }
        .octo-t2 { animation-delay: 0.1s; }
        .octo-t3 { animation-delay: 0.2s; }
        .octo-t4 { animation-delay: 0.3s; }
        .octo-t5 { animation-delay: 0.4s; }
        .octo-t6 { animation-delay: 0.5s; }
        @keyframes octo-dash { to { stroke-dashoffset: -84; } }
        @keyframes octo-bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        /* Pink Octopus Loading Animations */
        .octopus-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .octopus-container img {
            animation: octopus-bounce 2s ease-in-out infinite;
        }
        
        @keyframes octopus-bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-20px) scale(1.1);
            }
            60% {
                transform: translateY(-10px) scale(1.05);
            }
        }
        
        /* Add a subtle glow effect */
        .octopus-container::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            animation: glow-pulse 3s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }

        /* Bouncing brand text */
        .octo-brand { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .octo-letters { font-weight: 800; font-size: 1.125rem; letter-spacing: 0.5px; }
        .octo-letter { display: inline-block; transform: translateY(0); animation: letter-bounce 1.2s ease-in-out infinite; animation-delay: calc(var(--i) * 0.08s); }
        .text-gradient { background: linear-gradient(90deg, var(--octo-color), #EC4899, #06B6D4); background-size: 200% 100%; -webkit-background-clip: text; background-clip: text; color: transparent; animation: gradient-move 5s linear infinite; }
        @keyframes letter-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes gradient-move { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }

        /* Tooltips */
    .tooltip { 
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        /* COMPREHENSIVE DARK MODE SYSTEM */
        
        /* Base dark mode */
        .dark { color-scheme: dark; }
        .dark body { 
            background-color: #0B1120 !important; 
            color: #E2E8F0 !important; 
        }
        
        /* Dark mode - Typography hierarchy (consistent specificity) */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6 { 
            color: #F1F5F9 !important; 
        }
        .dark p, .dark span, .dark div { 
            color: #E2E8F0 !important; 
        }
        .dark .text-gray-900 { color: #F1F5F9 !important; }
        .dark .text-gray-800 { color: #F1F5F9 !important; }
        .dark .text-gray-700 { color: #E2E8F0 !important; }
        .dark .text-gray-600 { color: #CBD5E1 !important; }
        .dark .text-gray-500 { color: #94A3B8 !important; }
        .dark .text-gray-400 { color: #64748B !important; }
        .dark .text-muted { color: #64748B !important; }
        
        /* Dark mode - KPI values and important numbers */
        .dark #totalTickets, .dark #busiestDay, .dark #unassignedQueries,
        .dark #avgFirstResponse, .dark #avgResolutionTime, .dark #avgLifecycle { 
            color: #F1F5F9 !important; 
        }
        
        /* Dark mode - Primary backgrounds */
        .dark .bg-white { 
            background-color: #1E293B !important; 
            color: #E2E8F0 !important;
            border-color: #334155 !important;
        }
        
        /* Ensure light mode modals stay light */
        html:not(.dark) #agentModal .bg-white {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #E5E7EB !important;
        }
        html:not(.dark) #agentModal .bg-gray-50 {
            background-color: #F9FAFB !important;
            color: #111827 !important;
            border-color: #E5E7EB !important;
        }
        
        /* Force light mode styling for all modal content */
        html:not(.dark) #agentModal {
            background-color: rgba(0, 0, 0, 0.6) !important;
        }
        html:not(.dark) #agentModal > div {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #E5E7EB !important;
        }
        html:not(.dark) #agentModal h2,
        html:not(.dark) #agentModal h3,
        html:not(.dark) #agentModal h4 {
            color: #111827 !important;
        }
        html:not(.dark) #agentModal .text-gray-500 {
            color: #6B7280 !important;
        }
        html:not(.dark) #agentModal .text-gray-900 {
            color: #111827 !important;
        }
        html:not(.dark) #agentModal .border-b {
            border-color: #E5E7EB !important;
        }
        html:not(.dark) #agentModal table thead {
            background-color: #F9FAFB !important;
        }
        html:not(.dark) #agentModal table tbody tr {
            border-color: #E5E7EB !important;
        }
        html:not(.dark) #agentModal table tbody tr:hover {
            background-color: #F9FAFB !important;
        }
        .dark .bg-gray-50 { 
            background-color: #0F172A !important; 
            color: #E2E8F0 !important;
        }
        .dark .bg-gray-100 { 
            background-color: #334155 !important; 
            color: #E2E8F0 !important;
        }
        
        /* Dark mode - Semantic backgrounds */
        .dark .bg-indigo-100 { 
            background-color: #1E1B4B !important; 
            color: #C7D2FE !important; 
        }
        .dark .bg-red-50 { 
            background-color: #450A0A !important; 
            color: #FECACA !important; 
        }
        .dark .bg-yellow-100 { 
            background-color: #451A03 !important; 
            color: #FEF3C7 !important; 
        }
        .dark .bg-green-100 { 
            background-color: #064E3B !important; 
            color: #D1FAE5 !important; 
        }
        
        /* Dark mode - Borders (comprehensive) */
        .dark .border,
        .dark .border-gray-100,
        .dark .border-gray-200,
        .dark .border-gray-300 { 
            border-color: #334155 !important; 
        }
        .dark .border-b { border-color: #334155 !important; }
        .dark .border-t { border-color: #334155 !important; }
        .dark .border-l { border-color: #334155 !important; }
        .dark .border-r { border-color: #334155 !important; }
        
        /* Dark mode - Interactive hover states */
        .dark .hover\:bg-gray-50:hover { background-color: #0F172A !important; }
        .dark .hover\:bg-gray-100:hover { background-color: #334155 !important; }
        .dark .hover\:bg-white:hover { background-color: #1E293B !important; }
        .dark .hover\:bg-indigo-50:hover { background-color: #1E1B4B !important; }
        .dark .hover\:text-gray-800:hover { color: #F1F5F9 !important; }
        .dark .hover\:text-gray-600:hover { color: #CBD5E1 !important; }
        
        /* Dark mode - Form elements (comprehensive) */
        .dark input,
        .dark select,
        .dark textarea,
        .dark input[type="text"],
        .dark input[type="email"],
        .dark input[type="password"],
        .dark input[type="search"],
        .dark input[type="date"],
        .dark input[type="number"] { 
            background-color: #0F172A !important; 
            color: #E2E8F0 !important; 
            border-color: #334155 !important; 
        }
        .dark input:focus,
        .dark select:focus,
        .dark textarea:focus { 
            border-color: #60A5FA !important; 
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important; 
        }
        .dark input::placeholder { 
            color: #64748B !important; 
        }
        
        /* Dark mode - Tables (complete redesign) */
        .dark table { 
            background-color: #1E293B !important;
            border-color: #334155 !important;
        }
        .dark table thead th { 
            background-color: #0F172A !important; 
            color: #F1F5F9 !important; 
            border-bottom-color: #334155 !important;
        }
        .dark table tbody td, 
        .dark table tbody th { 
            color: #E2E8F0 !important; 
            border-bottom-color: #334155 !important;
        }
        .dark table tbody tr:nth-child(even) { 
            background-color: rgba(15, 23, 42, 0.5) !important; 
        }
        .dark table tbody tr:hover { 
            background-color: rgba(96, 165, 250, 0.08) !important; 
        }
        .dark table tbody tr[data-agent-name]:hover { 
            background-color: rgba(96, 165, 250, 0.12) !important; 
        }
        
        /* Dark mode - Component-specific (updated for consistency) */
        .dark #darkModeToggle { 
            background-color: transparent !important; 
            color: #E2E8F0 !important; 
        }
        .dark #chartToggle { 
            background-color: #334155 !important; 
        }
        .dark #chartToggle .btn-toggle { 
            color: #94A3B8 !important; 
        }
        .dark #chartToggle .btn-toggle:hover { 
            color: #E2E8F0 !important; 
            background-color: rgba(0,0,0,0.3) !important; 
        }
        .dark #chartToggle .btn-toggle.active { 
            color: #FFFFFF !important; 
            background: linear-gradient(135deg, #5B21B6 0%, #7C2D12 100%) !important; 
        }
        
        /* Dark mode - Tooltips */
        .dark .tooltip { 
            background-color: #1F2937 !important; 
            color: #F1F5F9 !important; 
            border: 1px solid #334155 !important;
        }
        
        /* Dark mode - Missing UI elements */
        .dark .text-gray-400 { color: #64748B !important; }
        .dark .hover\:text-gray-600:hover { color: #CBD5E1 !important; }
        .dark .border-gray-100 { border-color: #334155 !important; }
        .dark .border-gray-200 { border-color: #334155 !important; }
        .dark .shadow-sm { box-shadow: var(--shadow-sm) !important; }
        .dark .shadow-md { box-shadow: var(--shadow-md) !important; }
        .dark .shadow-lg { box-shadow: var(--shadow-lg) !important; }
        .dark .shadow-xl { box-shadow: var(--shadow-xl) !important; }
        
        /* Dark mode - Special buttons */
        .dark .flag-btn { 
            background-color: #451A03 !important; 
            color: #FEF3C7 !important; 
            border-color: #78350F !important;
        }
        .dark .flag-btn:hover { 
            background-color: #78350F !important; 
        }
        
        /* Dark mode - Loading states */
        .dark #loader { 
            background-color: #0B1120 !important; 
        }
        
        /* Force light mode for flyout handle */
        html:not(.dark) #flyoutHandle {
            background-color: #FFFFFF !important;
            color: #374151 !important;
            border-color: #D1D5DB !important;
        }
        html:not(.dark) #flyoutHandle:hover {
            background-color: #F9FAFB !important;
            color: #111827 !important;
        }
        html:not(.dark) #flyoutPanel {
            background-color: #FFFFFF !important;
            color: #111827 !important;
            border-color: #D1D5DB !important;
        }
        html:not(.dark) .flyout-header {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border-color: #D1D5DB !important;
        }
        html:not(.dark) .flyout-header h3 {
            color: #111827 !important;
        }
        
        /* Comprehensive light mode text fixes */
        html:not(.dark) h1,
        html:not(.dark) h2,
        html:not(.dark) h3,
        html:not(.dark) h4,
        html:not(.dark) h5,
        html:not(.dark) h6 {
            color: #111827 !important;
        }
        
        html:not(.dark) .text-gray-500 {
            color: #6B7280 !important;
        }
        html:not(.dark) .text-gray-900 {
            color: #111827 !important;
        }
        html:not(.dark) .text-gray-700 {
            color: #374151 !important;
        }
        html:not(.dark) .font-bold {
            color: #111827 !important;
        }
        html:not(.dark) .font-semibold {
            color: #111827 !important;
        }
        
        /* Monthly report specific fixes */
        html:not(.dark) #monthlyReportSection h1,
        html:not(.dark) #monthlyReportSection h2,
        html:not(.dark) #monthlyReportSection h3,
        html:not(.dark) #monthlyReportSection h4,
        html:not(.dark) #monthlyReportSection .font-bold,
        html:not(.dark) #monthlyReportSection .font-semibold,
        html:not(.dark) #monthlyReportSection .text-2xl {
            color: #111827 !important;
        }
        
        /* Agent table fixes */
        html:not(.dark) .bg-white th,
        html:not(.dark) .bg-white td,
        html:not(.dark) .bg-white p,
        html:not(.dark) .bg-white span {
            color: #374151 !important;
        }
        html:not(.dark) .bg-white .font-medium,
        html:not(.dark) .bg-white .font-semibold,
        html:not(.dark) .bg-white .font-bold {
            color: #111827 !important;
        }
        
        /* Comprehensive dark mode fixes */
        .dark #agentModal {
            background-color: rgba(15, 23, 42, 0.8) !important;
        }
        .dark #agentModal .bg-white {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border-color: #334155 !important;
        }
        .dark #agentModal .bg-gray-50 {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        .dark #agentModal th {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        .dark #agentModal td {
            color: #cbd5e1 !important;
            border-color: #475569 !important;
        }
        .dark #agentModal .font-medium,
        .dark #agentModal .font-semibold,
        .dark #agentModal .font-bold {
            color: #f1f5f9 !important;
        }
        
        /* Flyout dark mode comprehensive fixes */
        .dark #flyoutPanel {
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }
        .dark #flyoutPanel .flyout-header {
            background-color: rgba(30, 41, 59, 0.9) !important;
            border-color: #334155 !important;
        }
        .dark #flyoutPanel h3,
        .dark #flyoutPanel label,
        .dark #flyoutPanel span {
            color: #f1f5f9 !important;
        }
        .dark #flyoutPanel input,
        .dark #flyoutPanel select {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        .dark #flyoutPanel input:focus,
        .dark #flyoutPanel select:focus {
            border-color: #60a5fa !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
        }
        .dark #flyoutPanel button {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        .dark #flyoutPanel button:hover {
            background-color: #475569 !important;
        }
        
        /* Table dark mode fixes */
        .dark table {
            background-color: #1e293b !important;
        }
        .dark th {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #475569 !important;
        }
        .dark td {
            color: #cbd5e1 !important;
            border-color: #475569 !important;
        }
        .dark tr:hover {
            background-color: #334155 !important;
        }
        
        /* Button dark mode fixes */
        .dark .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
            color: #ffffff !important;
            border-color: #1d4ed8 !important;
        }
        .dark .btn-secondary {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #475569 !important;
        }
        .dark .btn-secondary:hover {
            background-color: #475569 !important;
        }
        
        /* Input dark mode fixes */
        .dark input[type="text"],
        .dark input[type="search"],
        .dark input[type="date"],
        .dark select,
        .dark textarea {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        .dark input[type="text"]:focus,
        .dark input[type="search"]:focus,
        .dark input[type="date"]:focus,
        .dark select:focus,
        .dark textarea:focus {
            border-color: #60a5fa !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
        }
        .dark input::placeholder {
            color: #94a3b8 !important;
        }
        
        /* KPI Cards dark mode fixes */
        .dark .bg-gray-50 {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #475569 !important;
        }
        
        /* Modal hover states and button fixes for light mode */
        html:not(.dark) .hover\:bg-gray-50:hover {
            background-color: #f9fafb !important;
        }
        html:not(.dark) .hover\:bg-indigo-200:hover {
            background-color: #c7d2fe !important;
        }
        html:not(.dark) .hover\:bg-yellow-200:hover {
            background-color: #fef08a !important;
        }
        
        /* View on Slack button light mode styling */
        html:not(.dark) .bg-indigo-100 {
            background-color: #e0e7ff !important;
            color: #3730a3 !important;
            border: 1px solid #c7d2fe !important;
        }
        html:not(.dark) .bg-indigo-100:hover {
            background-color: #c7d2fe !important;
            color: #312e81 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Flag button light mode styling */
        html:not(.dark) .bg-yellow-100 {
            background-color: #fef3c7 !important;
            color: #92400e !important;
            border: 1px solid #fde68a !important;
        }
        html:not(.dark) .bg-yellow-100:hover {
            background-color: #fef08a !important;
            color: #78350f !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Modern flat design for all buttons */
        html:not(.dark) button {
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Table row hover states for light mode */
        html:not(.dark) tr:hover {
            background-color: #f8fafc !important;
            transform: scale(1.001) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }
        .dark .loader-circle { 
            border-color: #334155 !important;
            border-top-color: #60A5FA !important;
        }
        .dark .loader-particle:nth-child(1) { background: #60A5FA !important; }
        .dark .loader-particle:nth-child(2) { background: #34D399 !important; }
        .dark .loader-particle:nth-child(3) { background: #FBBF24 !important; }
        .dark .loader-particle:nth-child(4) { background: #F87171 !important; }
        .dark #loader { --octo-color: #60A5FA !important; }
        .dark .brand-logo { filter: drop-shadow(0 1px 1.5px rgba(0,0,0,0.24)); }
        .dark .brand-loader::after { 
            background: linear-gradient(120deg, transparent 47%, rgba(255,255,255,0.08) 50%, transparent 53%); 
        }
        .dark .brand-logo path,
        .dark .brand-logo circle,
        .dark .brand-logo rect,
        .dark .brand-logo polygon,
        .dark .brand-logo polyline,
        .dark .brand-logo ellipse,
        .dark .brand-logo text { stroke: none; }
        
        /* Dark mode - Brand logo text */
        .dark .brand-logo text { color: #F1F5F9 !important; }
        .dark #chartLoading { 
            background-color: rgba(11, 17, 32, 0.95) !important; 
        }
        /* Google Sign-in button styles */
        #googleSignInBtn { 
            background-color: #ffffff; 
            color: #3c4043; 
            border-color: #dadce0; 
        }
        #googleSignInBtn:hover { background-color: #f8f9fa; }
        .google-icon { 
            width: 20px; 
            height: 20px; 
            display: inline-block; 
            image-rendering: auto; 
        }
        
        /* Google Sign-in button - Dark mode */
        .dark #googleSignInBtn { 
            background-color: #ffffff !important; 
            color: #3c4043 !important; 
            border-color: #dadce0 !important; 
        }
        .dark #googleSignInBtn:hover { background-color: #f8f9fa !important; }
        
        /* Screen reader only text */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

        /* Global UX refresh tweaks */
        html { scroll-behavior: smooth; }
        :root {
            --ring: #4F46E5;
            --ring-dark: #60A5FA;
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .dark {
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 8px 10px -6px rgba(0, 0, 0, 0.6);
        }
        :focus-visible {
            outline: 2px solid var(--ring);
            outline-offset: 2px;
        }
        .dark :focus-visible { outline-color: var(--ring-dark); }
        
        /* Typography improvements */
        h1, h2, h3, h4, h5, h6 { color: #111827; }
        .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6 { color: #F9FAFB; }
        p, span, div { color: #374151; }
        .dark p, .dark span, .dark div { color: #D1D5DB; }
        .text-muted { color: #6B7280; font-size: 0.875rem; }
        .dark .text-muted { color: #9CA3AF; }
        /* Light, subtle background gradient */
        body { background-image: radial-gradient(40rem 40rem at 10% 0%, rgba(79,70,229,0.06), transparent), radial-gradient(30rem 30rem at 90% 10%, rgba(6,182,212,0.05), transparent); }
        .dark body { background-image: radial-gradient(40rem 40rem at 10% 0%, rgba(96,165,250,0.08), transparent), radial-gradient(30rem 30rem at 90% 10%, rgba(236,72,153,0.06), transparent); }
        /* Card polish for common white containers */
        .bg-white { 
            border: 1px solid rgba(0,0,0,0.08); 
            border-radius: 16px; 
            box-shadow: var(--shadow-sm); 
            transition: all 200ms ease;
        }
        .bg-white:hover { 
            box-shadow: var(--shadow-md); 
            border-color: rgba(0,0,0,0.12);
        }
        .dark .bg-white { 
            border-color: rgba(255,255,255,0.1); 
            box-shadow: var(--shadow-sm);
        }
        .dark .bg-white:hover { 
            box-shadow: var(--shadow-md); 
            border-color: rgba(255,255,255,0.15);
        }
        
        /* Dark mode - Modern cards consistency */
        .dark .bg-white.rounded-xl,
        .dark .bg-white.rounded-2xl { 
            background-color: #1E293B !important; 
            color: #E2E8F0 !important;
            border-color: #334155 !important;
        }
        .dark .bg-white.rounded-xl:hover,
        .dark .bg-white.rounded-2xl:hover { 
            background-color: #1E293B !important;
            border-color: #475569 !important;
        }
        /* Modern button system */
        button { 
            transition: all 200ms cubic-bezier(0.2, 0, 0, 1); 
            font-weight: 500;
            border-radius: 10px;
        }
        button:active { transform: translateY(1px) scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        
        /* Primary buttons */
        .btn-primary { 
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow-sm), 0 1px 0 rgba(255,255,255,0.1) inset;
            padding: 0.75rem 1.5rem;
        }
        .btn-primary:hover { 
            box-shadow: var(--shadow-md), 0 1px 0 rgba(255,255,255,0.2) inset;
            transform: translateY(-1px);
        }
        .dark .btn-primary { 
            background: linear-gradient(135deg, #5B21B6 0%, #7C2D12 100%);
        }
        
        /* Secondary buttons */
        .btn-secondary { 
            background: #FFFFFF; 
            color: #374151; 
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow-xs);
            padding: 0.75rem 1.5rem;
        }
        .btn-secondary:hover { 
            background: #F9FAFB; 
            border-color: rgba(0,0,0,0.15);
            box-shadow: var(--shadow-sm);
        }
        .dark .btn-secondary { 
            background: #1E293B !important; 
            color: #E2E8F0 !important; 
            border-color: #334155 !important;
        }
        .dark .btn-secondary:hover { 
            background: #0F172A !important; 
            border-color: #475569 !important;
        }
        
        /* Legacy button support */
        .bg-indigo-600 { 
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            box-shadow: var(--shadow-sm);
        }
        .bg-indigo-600:hover { 
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        .dark .bg-indigo-600 { 
            background: linear-gradient(135deg, #5B21B6 0%, #7C2D12 100%);
        }
        /* Modern tabs and toggles - Enhanced visibility */
        
        /* Button toggles (chart controls) */
        .btn-toggle {
            color: #6B7280;
            background: transparent;
            border: none;
            font-weight: 500;
        }
        .btn-toggle:hover {
            color: #374151;
            background: rgba(255,255,255,0.7);
        }
        .btn-toggle.active {
            color: #FFFFFF;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }
        .dark .btn-toggle {
            color: #9CA3AF;
        }
        .dark .btn-toggle:hover {
            color: #E5E7EB;
            background: rgba(0,0,0,0.3);
        }
        .dark .btn-toggle.active {
            color: #FFFFFF;
            background: linear-gradient(135deg, #5B21B6 0%, #7C2D12 100%);
            box-shadow: 0 2px 4px rgba(91, 33, 182, 0.3);
        }
        /* Flyout handle animations & polish */
        #flyoutPanel { transition: transform 260ms cubic-bezier(0.2, 0, 0, 1) !important; will-change: transform; }
        #flyoutBackdrop { transition: opacity 220ms ease, background-color 160ms ease; opacity: 0; }
        #flyoutBackdrop:not(.hidden) { opacity: 1; }
        #flyoutHandle { transition: transform 220ms cubic-bezier(0.2, 0, 0, 1), background-color 160ms ease, box-shadow 160ms ease, color 160ms ease; }
        #flyoutHandle:hover { transform: translateY(-50%) translateX(2px); }
        #flyoutHandle:active { transform: translateY(-50%) translateX(3px); }
        #flyoutHandleIcon { display: inline-block; transition: transform 220ms cubic-bezier(0.2, 0, 0, 1); will-change: transform; }
        #flyoutHandle[data-open="true"] #flyoutHandleIcon { transform: rotate(180deg); }
        /* Flyout panel - Light mode */
        html:not(.dark) #flyoutPanel { background-color: #FFFFFF !important; color: #111827; }
        html:not(.dark) #flyoutPanel .bg-white { background-color: #FFFFFF !important; }
        html:not(.dark) #flyoutPanel .border { border-color: rgba(0,0,0,0.12) !important; }
        html:not(.dark) #flyoutPanel .dark\:bg-gray-900 { background-color: #FFFFFF !important; }
        
        /* Flyout panel - Dark mode */
        .dark #flyoutPanel { 
            background-color: #1E293B !important; 
            color: #E2E8F0 !important; 
            border-color: #475569 !important;
        }
        .dark #flyoutPanel .bg-white { 
            background-color: #1E293B !important; 
            color: #E2E8F0 !important;
        }
        .dark #flyoutPanel .border { 
            border-color: #475569 !important; 
        }
        .dark #flyoutHandle { 
            background-color: #1E293B !important; 
            color: #E2E8F0 !important; 
            border-color: #475569 !important;
        }
        .dark #flyoutHandle:hover { 
            background-color: #334155 !important; 
        }
        /* Drawer surface tint (Material 3 style) */
        #flyoutPanel::after {
            content: '';
            position: absolute; inset: 0; border-radius: inherit; pointer-events: none;
            background: linear-gradient(to bottom, rgba(103,80,164,0.06), rgba(103,80,164,0.00) 40%);
            mix-blend-mode: multiply;
        }
        .dark #flyoutPanel::after { background: linear-gradient(to bottom, rgba(103,80,164,0.14), rgba(103,80,164,0.00) 40%); }
        /* Flyout header - Light mode */
        html:not(.dark) .flyout-header { 
            border-color: rgba(0,0,0,0.12); 
            background-color: rgba(255,255,255,0.9) !important;
        }
        html:not(.dark) .flyout-header h3 { color: #111827; }
        
        /* Flyout header - Dark mode */
        .dark .flyout-header { 
            border-color: #334155 !important; 
            background-color: rgba(30, 41, 59, 0.9) !important;
        }
        .dark .flyout-header h3 { 
            color: #F1F5F9 !important; 
        }
        /* Material ripple */
        .md-ripple { position: relative; overflow: hidden; }
        .md-ripple__wave { position: absolute; border-radius: 9999px; transform: scale(0); opacity: 0.15; background: currentColor; animation: md-ripple 480ms ease-out forwards; pointer-events: none; }
        @keyframes md-ripple { to { transform: scale(1); opacity: 0; } }
        @media (prefers-reduced-motion: reduce) {
            #flyoutPanel, #flyoutBackdrop, #flyoutHandle, #flyoutHandleIcon { transition: none !important; }
        }
        /* Flyout: stack filters vertically when inside flyout */
        .as-flyout .grid { display: grid; grid-template-columns: 1fr !important; gap: 0.75rem !important; }
        .as-flyout .flex { flex-direction: column !important; align-items: stretch !important; gap: 0.5rem !important; }
        .as-flyout select, .as-flyout input, .as-flyout button { width: 100%; }
        .as-flyout > * + * { margin-top: 0.75rem; }
        .as-flyout .justify-end { justify-content: flex-start !important; }
        .as-flyout .items-end { align-items: stretch !important; }
        .as-flyout .w-full, .as-flyout .sm\:w-auto { width: 100% !important; }
        .as-flyout .rounded-lg.shadow { width: 100% !important; margin-left: 0 !important; margin-right: 0 !important; }
        /* Consistent chip styling */
        .chip { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.75rem; font-size: 0.875rem; border-radius: 9999px; border: 1px solid #E5E7EB; background-color: #FFFFFF; color: #374151; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .chip:hover { background-color: #F9FAFB; }
        .chip--active { background-color: #4F46E5; color: #FFFFFF; border-color: #4F46E5; }
        .dark .chip { background-color: #1F2937; color: #E5E7EB; border-color: #374151; }
        .dark .chip:hover { background-color: #111827; }
        .dark .chip--active { background-color: #60A5FA; color: #0B0B0B; border-color: #60A5FA; }
        /* Modern table design */
        table { 
            font-size: 0.95rem; 
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: var(--shadow-xs);
        }
        table thead th { 
            font-weight: 600; 
            color: #374151; 
            letter-spacing: 0.025em; 
            background: #F8FAFC;
            border-bottom: 1px solid #E2E8F0;
            padding: 1rem 0.75rem;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        table tbody tr { 
            transition: all 150ms ease;
            border-bottom: 1px solid #F1F5F9;
        }
        table tbody tr:nth-child(even) { background-color: rgba(248,250,252,0.5); }
        table tbody tr:hover { 
            background-color: rgba(79,70,229,0.04); 
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        table tbody tr[data-agent-name]:hover {
            background-color: rgba(79,70,229,0.08);
            cursor: pointer;
        }
        table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
        }
        
        /* Dark mode tables */
        .dark table thead th { 
            color: #E2E8F0; 
            background: #1E293B;
            border-bottom-color: #334155;
        }
        .dark table tbody tr { border-bottom-color: #334155; }
        .dark table tbody tr:nth-child(even) { background-color: rgba(30,41,59,0.3); }
        .dark table tbody tr:hover { 
            background-color: rgba(96,165,250,0.08); 
        }
        .dark table tbody tr[data-agent-name]:hover {
            background-color: rgba(96,165,250,0.12);
        }
        
        /* Modern form inputs */
        input, select, textarea {
            transition: all 200ms ease;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            font-size: 0.95rem;
            font-weight: 400;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            transform: translateY(-1px);
        }
        input::placeholder {
            color: #94A3B8;
            font-weight: 400;
        }
        .dark input, .dark select, .dark textarea {
            border-color: #334155 !important;
            background: #0F172A !important;
            color: #E2E8F0 !important;
        }
        .dark input:focus, .dark select:focus, .dark textarea:focus {
            border-color: #60A5FA !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
            background: #0F172A !important;
        }
        .dark input::placeholder {
            color: #64748B !important;
        }
        
        /* Enhanced tooltips */
        .tooltip { 
            visibility: hidden;
            opacity: 0;
            transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(4px);
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .dark .tooltip { 
            background-color: #1F2937; 
            color: #F3F4F6; 
            border: 1px solid #374151;
        }
        /* Monthly cards: consistent headings & spacing (match dashboard) */
        #monthlyReportSection h2 { letter-spacing: -0.01em; margin-bottom: 1.0rem; font-weight: 700; }
        #monthlyReportSection h3 { letter-spacing: -0.005em; margin-bottom: 0.75rem; font-weight: 600; }
        #monthlyReportSection .rounded-lg.shadow { border-radius: 12px; }
        /* Monthly section - Light mode hardening */
        html:not(.dark) #monthlyReportSection { color: #374151; }
        html:not(.dark) #monthlyReportSection h1,
        html:not(.dark) #monthlyReportSection h2,
        html:not(.dark) #monthlyReportSection h3,
        html:not(.dark) #monthlyReportSection h4 { color: #111827; }
        html:not(.dark) #monthlyReportSection .bg-white { background-color: #FFFFFF !important; }
        html:not(.dark) #monthlyReportSection .bg-gray-50 { background-color: #F9FAFB !important; }
        html:not(.dark) #monthlyReportSection .shadow { background-color: #FFFFFF; }
        
        /* Monthly section - Dark mode consistency */
        .dark #monthlyReportSection { color: #E2E8F0 !important; }
        .dark #monthlyReportSection h1,
        .dark #monthlyReportSection h2,
        .dark #monthlyReportSection h3,
        .dark #monthlyReportSection h4 { color: #F1F5F9 !important; }
        .dark #monthlyReportSection .bg-white { 
            background-color: #1E293B !important; 
            color: #E2E8F0 !important;
            border-color: #334155 !important;
        }
        .dark #monthlyReportSection .bg-gray-50 { 
            background-color: #0F172A !important; 
            color: #E2E8F0 !important;
        }
        .dark #monthlyReportSection .shadow { 
            background-color: #1E293B !important; 
        }
        /* Monthly container gutters and card spacing */
        #monthlyReportSection .grid { gap: 2.5rem; }
        #monthlyReportSection .chart-container { padding: 0.25rem; }
        /* Dark overrides remain via .dark ... already defined above */
        /* Sticky month nav backdrop compatibility */
        #monthNav { -webkit-backdrop-filter: saturate(120%) blur(8px); backdrop-filter: saturate(120%) blur(8px); border-color: rgba(229,231,235,0.9); }
        /* Chevron transition */
        [data-chevron] { transition: transform 160ms ease; }
        /* Prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
            html { scroll-behavior: auto; }
            [data-chevron] { transition: none; }
        }
  </style>
<script>
(function(){
  const originalGet = Storage.prototype.getItem;
  const originalSet = Storage.prototype.setItem;
  const originalRemove = Storage.prototype.removeItem;
  const shouldSessionize = (key) => typeof key === 'string' && /(scroll|filter)/i.test(key);
  try {
    const toCopy = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (shouldSessionize(k)) toCopy.push(k);
    }
    toCopy.forEach(k => {
      try {
        const v = originalGet.call(localStorage, k);
        if (v !== null) originalSet.call(sessionStorage, k, v);
        originalRemove.call(localStorage, k);
      } catch (_) {}
    });
  } catch (_) {}
  localStorage.getItem = function(key){
    if (shouldSessionize(key)) {
      try {
        const v = originalGet.call(sessionStorage, key);
        if (v !== null) return v;
        const tmp = originalGet.call(this, key);
        if (tmp !== null) {
          try { originalSet.call(sessionStorage, key, tmp); originalRemove.call(this, key); } catch (_) {}
          return tmp;
        }
        return null;
      } catch (_) { return null; }
    }
    return originalGet.call(this, key);
  };
  localStorage.setItem = function(key, value){
    if (shouldSessionize(key)) {
      try { originalSet.call(sessionStorage, key, value); } catch (_) {}
      try { originalRemove.call(this, key); } catch (_) {}
      return;
    }
    return originalSet.call(this, key, value);
  };
  localStorage.removeItem = function(key){
    if (shouldSessionize(key)) {
      try { originalRemove.call(sessionStorage, key); } catch (_) {}
      try { originalRemove.call(this, key); } catch (_) {}
      return;
    }
    return originalRemove.call(this, key);
  };
})();
</script>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Generic Flyout Component -->
    <div id="flyoutBackdrop" class="hidden fixed inset-0 bg-white/85 backdrop-blur-sm z-[60]"></div>
    <!-- Edge handle for flyout -->
    <button id="flyoutHandle" class="fixed top-1/2 -translate-y-1/2 right-0 z-[62] bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-l-full shadow-md px-3 py-2 text-sm font-semibold text-gray-700 dark:text-gray-100 flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-slate-700 transition-all duration-250 hidden md-ripple" aria-label="Open filters" title="Open filters" style="transform: translateY(-50%) translateX(0); transition: transform 250ms cubic-bezier(0.4, 0, 0.2, 1);">
        <svg id="flyoutHandleIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        <span class="pr-1">Filters</span>
    </button>
    <aside id="flyoutPanel" aria-hidden="true" role="dialog" aria-labelledby="flyoutTitle" class="hidden fixed top-0 right-0 h-full w-full sm:w-[420px] max-w-full bg-white dark:bg-slate-800 shadow-2xl z-[61] transform translate-x-full transition-transform duration-300 cubic-bezier(0.4, 0, 0.2, 1) border-l border-gray-200 dark:border-slate-600 sm:rounded-tl-2xl sm:rounded-bl-2xl overflow-hidden">
        <div class="flyout-header flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-slate-600 sticky top-0 bg-white/90 dark:bg-slate-800/90 backdrop-blur">
            <h3 id="flyoutTitle" class="text-lg font-semibold tracking-tight text-gray-900 dark:text-gray-100">Filters</h3>
            <button id="flyoutClose" class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors duration-200" aria-label="Close filters">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="flyoutContent" class="p-4 sm:p-5 space-y-4 overflow-y-auto h-[calc(100%-56px)] as-flyout">
            <div class="grid grid-cols-1 gap-3">
                <div class="grid grid-cols-1 gap-2">
                    <label for="categoryFilter" class="font-semibold">Smart Hub</label>
                    <div id="flyoutCategoryMount"></div>
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <label for="dateRangeFilter" class="font-semibold">Time Period</label>
                    <div id="flyoutRangeMount"></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div id="flyoutResetMount"></div>
                    <div id="flyoutCsvMount"></div>
                </div>
                <div id="flyoutCustomDates" class="grid grid-cols-1 gap-3 hidden">
                    <div class="grid grid-cols-1 gap-2">
                        <label for="dateFrom" class="font-semibold">Start Date</label>
                        <div id="flyoutStartMount"></div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <label for="dateTo" class="font-semibold">End Date</label>
                        <div id="flyoutEndMount"></div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Dark mode toggle (top-right) -->
    <button id="darkModeToggle" class="fixed top-3 right-3 text-2xl z-50 p-2 rounded-lg bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border border-gray-200 dark:border-gray-700 hover:bg-white dark:hover:bg-gray-800 transition-all duration-200 shadow-sm hover:shadow-md" aria-label="Toggle dark mode" title="Switch between light and dark mode"></button>
    <!-- Global Tabs (always visible) -->
    <div class="container mx-auto px-4 pt-14">
        <nav id="topTabs" class="mb-6 flex items-center gap-1" role="tablist" aria-label="Primary views">
            <button id="tabDashboard" class="tab-btn active" role="tab" aria-selected="true" aria-controls="dashboard">Dashboard</button>
            <button id="tabMonthly" class="tab-btn" role="tab" aria-selected="false" aria-controls="monthlyReportSection">Monthly Report</button>
        </nav>
    </div>

  <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
                    <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md text-center">
            <div>
                <h2 class="text-3xl font-extrabold text-gray-900">Smart Hub Dashboard</h2>
                <p class="mt-2 text-gray-600">Please sign in with your company Google account to continue.</p>
            </div>
            <div id="loginError" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
            <div>
                <button id="googleSignInBtn" class="w-full inline-flex justify-center items-center px-4 py-3 border rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" style="border-color:#dadce0;color:#3c4043;">
                    <img class="google-icon w-5 h-5 mr-3" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" aria-hidden="true" />
                    Sign in with Google
                </button>
            </div>
    </div>
  </div>

  <div id="appContainer" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">Smart Hub Dashboard</h1>
            <p class="mt-2 text-lg text-gray-600">Analyse query trends and agent performance by site.</p>
    </header>
        

        <!-- Loading and Error Section -->
        <div id="loader" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-pink-50 to-purple-100 dark:from-gray-900 dark:to-gray-800 z-50">
            <div class="flex flex-col items-center">
                <!-- Pink Octopus Loading Screen -->
                <div class="brand-loader" id="brandLoader">
                    <div class="octopus-container mb-8">
                        <img src="pink-octopus.png" alt="Pink Octopus" class="w-32 h-32 animate-bounce" />
                    </div>
                    <div class="mt-8 text-center">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Smart Hub Dashboard</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-300">Loading your personalised insights...</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="errorMessage" class="text-center py-10 text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-6 rounded-xl border border-red-200 dark:border-red-800" style="display: none;">
            <div class="max-w-md mx-auto">
                <div class="text-4xl mb-4"></div>
                <h3 class="text-lg font-semibold mb-2">Connection Issue</h3>
                <p class="text-sm mb-4">We're having trouble loading your dashboard data.</p>
                <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                    Try Again
                </button>
            </div>
        </div>

        <!-- Main Dashboard -->
        <main id="dashboard" class="hidden">
            <!-- Filter Section (moved into flyout on load) -->
            <div id="dashboardFilters" class="hidden bg-white p-4 sm:p-6 rounded-lg shadow mb-6 sm:mb-8 space-y-4" role="region" aria-label="Data filters">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="sm:col-span-1">
                        <label for="categoryFilter" class="font-semibold text-gray-700 text-sm block">Smart Hub</label>
                        <select id="categoryFilter" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" aria-describedby="categoryFilterHelp"></select>
                        <span id="categoryFilterHelp" class="sr-only">Select a smart hub to filter data by location</span>
                    </div>
                    <div class="sm:col-span-1">
                        <label for="dateRangeFilter" class="font-semibold text-gray-700 text-sm block">Time Period</label>
                        <select id="dateRangeFilter" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" aria-describedby="dateRangeFilterHelp">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <span id="dateRangeFilterHelp" class="sr-only">Select the time period to analyse</span>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-2 flex flex-col sm:flex-row items-stretch sm:items-end justify-end space-y-2 sm:space-y-0 sm:space-x-2">
                         <button id="resetFiltersBtn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition text-sm font-medium w-full sm:w-auto">
                            Reset Filters
                        </button>
                        <button id="downloadCsvBtn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition text-sm font-medium w-full sm:w-auto"> Download CSV</button>
                    </div>
                </div>
                <div id="customDateRange" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t">
                     <div>
                        <label for="dateFrom" class="font-semibold text-gray-700 text-sm block">Start Date</label>
                        <input type="date" id="dateFrom" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="dateTo" class="font-semibold text-gray-700 text-sm block">End Date</label>
                        <input type="date" id="dateTo" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
      </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center space-x-2 text-gray-500 text-sm font-medium has-tooltip relative mb-3">
                        <h3 id="totalTicketsTitle" class="font-semibold">Total Tickets</h3>
                        <span class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors"></span>
                        <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-3 px-4 z-10 shadow-lg">
                            The total number of queries matching the current filter that were active in the selected stage (Submitted, Investigating, or Closed) within the selected time period.
                        </div>
                    </div>
                    <p id="totalTickets" class="text-4xl font-bold text-gray-900 mt-1 tracking-tight">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center space-x-2 text-gray-500 text-sm font-medium has-tooltip relative mb-3">
                        <h3 id="busiestDayTitle" class="font-semibold">Busiest Day</h3>
                        <span class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors"></span>
                        <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-3 px-4 z-10 shadow-lg">
                            The single day with the highest number of queries for the selected status within the selected time period.
                        </div>
                    </div>
                    <p id="busiestDay" class="text-4xl font-bold text-gray-900 mt-1 tracking-tight">-</p>
                    <p id="busiestDayCount" class="text-sm text-gray-500 mt-2"></p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center space-x-2 text-gray-500 text-sm font-medium has-tooltip relative mb-3">
                        <h3 class="font-semibold">Unassigned Queries</h3>
                        <span class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors"></span>
                        <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-3 px-4 z-10 shadow-lg">
                           The number of queries that have been submitted but have not yet been started by an agent, within the selected time period.
                        </div>
                    </div>
                    <p id="unassignedQueries" class="text-4xl font-bold text-gray-900 mt-1 tracking-tight">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center space-x-2 text-gray-500 text-sm font-medium has-tooltip relative mb-3">
                        <h3 class="font-semibold">Avg. Time to First Response</h3>
                        <span class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors"></span>
                        <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-3 px-4 z-10 shadow-lg">
                           The average time from when a query is <strong>submitted</strong> until it is <strong>started</strong>. This is your team's "reaction time."
                        </div>
                    </div>
                    <p id="avgFirstResponse" class="text-4xl font-bold text-gray-900 mt-1 tracking-tight">-</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                     <div class="flex items-center space-x-2 text-gray-500 text-sm font-medium has-tooltip relative mb-3">
                        <h3 class="font-semibold">Avg. Time to Resolution</h3>
                        <span class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors"></span>
                        <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-3 px-4 z-10 shadow-lg">
                           The average time from when a query is <strong>started</strong> until it is <strong>closed</strong>. This is the "work time."
                        </div>
                    </div>
                    <p id="avgResolutionTime" class="text-4xl font-bold text-gray-900 mt-1 tracking-tight">-</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center space-x-2 text-gray-500 text-sm font-medium has-tooltip relative mb-3">
                        <h3 class="font-semibold">Avg. Full Lifecycle</h3>
                        <span class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors"></span>
                        <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-3 px-4 z-10 shadow-lg">
                           The total average time from when a query is <strong>submitted</strong> until it is <strong>closed</strong>. This is the "total customer experience time."
                        </div>
                    </div>
                    <p id="avgLifecycle" class="text-4xl font-bold text-gray-900 mt-1 tracking-tight">-</p>
        </div>
      </div>

            <!-- Main Chart -->
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-12 hover:shadow-md transition-all duration-200">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
                    <h3 id="mainChartTitle" class="text-2xl font-bold tracking-tight text-gray-900">Category Comparison</h3>
                    <div id="chartToggle" class="flex items-center space-x-1 p-1 bg-gray-100 rounded-xl w-fit shadow-inner">
                        <button data-metric="submitted" class="btn-toggle px-4 py-2 rounded-lg text-sm font-medium transition-all">Submitted</button>
                        <button data-metric="started" class="btn-toggle px-4 py-2 rounded-lg text-sm font-medium transition-all">Investigating</button>
                        <button data-metric="completed" class="btn-toggle active px-4 py-2 rounded-lg text-sm font-medium transition-all">Closed</button>
                    </div>
                </div>
                <div id="mainChartContainer" class="chart-container relative">
                    <div id="chartLoading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-95 backdrop-blur-sm hidden rounded-lg">
                        <div class="text-center">
                            <!-- Simple chart loader -->
                            <div class="simple-loader mx-auto mb-4" style="width: 40px; height: 40px;">
                                <div class="loader-circle" style="width: 40px; height: 40px; border-width: 2px;"></div>
                                <div class="loader-particle" style="width: 3px; height: 3px;"></div>
                                <div class="loader-particle" style="width: 3px; height: 3px;"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Loading chart...</span>
                        </div>
                    </div>
                    <canvas id="ticketsByDayChart" role="img" aria-label="Operations dashboard main chart showing ticket trends"></canvas>
        </div>
                <div id="chartExplanationContainer" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-700">How to Read This Data</h4>
                    <p id="chartExplanation" class="text-sm text-gray-600 mt-1"></p>
      </div>
    </div>

            <!-- Agent Leaderboard -->
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                    <h3 id="leaderboardTitle" class="text-2xl font-bold tracking-tight text-gray-900">Leaderboard</h3>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search by agent name..." class="w-full sm:w-80 pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 focus:bg-white transition-all" />
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div id="leaderboardContainer"></div>
            </div>
        </main>
        <!-- Monthly Report Tab (embedded) -->
        <section id="monthlyReportSection" class="hidden bg-white p-0 rounded-2xl shadow-sm border border-gray-100 overflow-hidden" aria-label="Monthly Report">
            <div id="loaderMonthly" class="flex items-center justify-center bg-gray-50" style="min-height: 160px;">
                <div class="flex flex-col items-center p-6">
                    <div class="brand-loader" id="brandLoaderMonthly" data-src="https://assets.octopusenergy.com/826x366/4197eacfc9/octopus-energy.svg">
                        <noscript>
                            <img class="brand-logo" src="https://assets.octopusenergy.com/826x366/4197eacfc9/octopus-energy.svg" alt="Octopus Energy" />
                        </noscript>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">Loading your dashboard...</p>
                </div>
            </div>
            <div id="errorMonthly" class="text-center py-6 text-red-600 bg-red-50 p-4" style="display: none;"></div>
            <main id="monthlyReportContent" class="hidden p-4 sm:p-6">
                <nav id="monthNav" class="sticky top-0 z-20 -mt-4 -mx-4 sm:-mx-6 px-4 sm:px-6 py-2 bg-white dark:bg-gray-900 border-b shadow-sm mb-4 overflow-x-auto whitespace-nowrap hidden">
                    <div class="inline-flex items-center gap-2 mr-3">
                        <button id="expandAllMonths" class="px-2 py-1 text-xs rounded border bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:hover:bg-gray-700">Expand all</button>
                        <button id="collapseAllMonths" class="px-2 py-1 text-xs rounded border bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:hover:bg-gray-700">Collapse all</button>
                    </div>
                </nav>
                <div id="monthlyFiltersPanel" class="hidden bg-white p-4 rounded-lg shadow mb-6 flex flex-col gap-3">
                    <div class="flex flex-wrap items-center gap-3">
                        <label for="categoryFilterMonthly" class="font-semibold text-gray-700">Smart Hub:</label>
                        <select id="categoryFilterMonthly" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                        
                        <label for="agentRollupMonthly" class="font-semibold text-gray-700 ml-2">Agents:</label>
                        <select id="agentRollupMonthly" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="top10" selected>Top 10</option>
                            <option value="top20">Top 20</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <label class="font-semibold text-gray-700">Quick Filters:</label>
                        <label class="inline-flex items-center gap-2"><input type="checkbox" id="hideDeactivatedMonthly" class="accent-indigo-600" checked> <span class="text-sm">Hide deactivated</span></label>
                        <label class="inline-flex items-center gap-2"><input type="checkbox" id="thisYearOnlyMonthly" class="accent-indigo-600"> <span class="text-sm">This year only</span></label>
                        <label class="inline-flex items-center gap-2"><input type="checkbox" id="weekendsOnlyMonthly" class="accent-indigo-600"> <span class="text-sm">Weekends only</span></label>
                    </div>
                </div>
                <div id="monthlyReportsContainer" class="space-y-8"></div>
            </main>
        </section>
    </div>

    <!-- Agent Modal -->
    <div id="agentModal" class="hidden fixed inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm flex justify-center items-center z-50 p-2 sm:p-4 modal-enter" role="dialog" aria-modal="true" aria-labelledby="agentModalName">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-5xl relative overflow-y-auto max-h-[95vh] sm:max-h-[90vh] modal-content-enter border border-gray-200 dark:border-slate-600">
            <button id="closeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none transition-colors" aria-label="Close modal">&times;</button>
            <h2 id="agentModalName" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Agent Name</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="agentKpis"></div>
            <div class="flex flex-wrap gap-1 sm:gap-2 mb-4 border-b border-gray-200 dark:border-slate-600" role="tablist" aria-label="Agent performance tabs">
                <button data-tab="summary" class="tab-btn active px-2 sm:px-4 py-2 font-medium text-sm" role="tab" aria-selected="true" aria-controls="tabContent">Summary</button>
                <button data-tab="inProgress" class="tab-btn px-2 sm:px-4 py-2 font-medium text-sm" role="tab" aria-selected="false" aria-controls="tabContent">In Progress</button>
                <button data-tab="weekly" class="tab-btn px-2 sm:px-4 py-2 font-medium text-sm" role="tab" aria-selected="false" aria-controls="tabContent">Weekly</button>
                <button data-tab="daily" class="tab-btn px-2 sm:px-4 py-2 font-medium text-sm" role="tab" aria-selected="false" aria-controls="tabContent">Daily</button>
            </div>
            <div id="tabContent" role="tabpanel">
                <div id="agentChartContainer" class="chart-container hidden">
                    <canvas id="agentChart" role="img" aria-label="Agent performance chart"></canvas>
                </div>
                <div id="agentSummaryContainer" class="overflow-y-auto max-h-[400px]"></div>
                <div id="agentInProgressContainer" class="overflow-y-auto max-h-[400px] hidden"></div>
    </div>
    </div>
  </div>


  
  <!-- Firebase 9.x version for better compatibility -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <script>
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
            console.error('Firebase is not loaded');
            alert('Firebase failed to load. Check your internet connection.');
        }

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuRWxAIvdau52AAcl8XdjMBDkHNl1bzMU",
            authDomain: "molten-verve-411115.firebaseapp.com",
            projectId: "molten-verve-411115",
            storageBucket: "molten-verve-411115.appspot.com",
            messagingSenderId: "514024347036",
            appId: "1:514024347036:web:1d71cb3b03c987de3d6459",
            measurementId: "G-4RJ3P39Z9J"
        };
        
        const ORGANISATION_DOMAIN = 'octoenergy.com';

        // Initialise Firebase using compat version
        let auth, provider;
        
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                provider = new firebase.auth.GoogleAuthProvider();
                
        provider.setCustomParameters({
                    'hd': ORGANISATION_DOMAIN
                });
                
                provider.addScope('profile');
                provider.addScope('email');
                
                window.firebaseReady = true;
            } else {
                console.error('Firebase not available for initialisation');
                window.firebaseReady = false;
            }
        } catch (error) {
            console.error('Firebase initialisation error:', error);
            window.firebaseReady = false;
            alert('Firebase initialisation failed: ' + error.message);
        }

        // --- CONFIGURATION ---
        const API_URL = 'https://us-central1-molten-verve-411115.cloudfunctions.net/googleSheetsProxy';
        const NAME_COLUMN = 'Name';
        const CATEGORY_COLUMN = 'Smart Hub';
        const DATE_COLUMNS = {
            submitted: ['submitted at', 'submitted'],
            started: ['started at', 'started'],
            completed: ['completed at', 'completed', 'closed']
        };
        const DATA_COLUMNS = {
            account: 'Account Number',
            slack: 'Slack link'
        };
        const STATUS_COLUMN = 'Status';
        const FLAG_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/17756424/uhmvzd5/';

        // --- DOM ELEMENTS ---
        // These will be declared inside DOMContentLoaded to ensure proper timing
        let loader, errorMessage, dashboard, searchInput, chartToggle;
        let categoryFilter, dateRangeFilter, agentModal, closeModalBtn;
        let leaderboardContainer, mainChartTitle, chartExplanation;
        let busiestDayTitle, totalTicketsTitle, leaderboardTitle;
        let resetFiltersBtn, customDateRange, dateFrom, dateTo;
        let agentInProgressContainer, downloadCsvBtn, darkModeToggle;
        // Flyout elements
        let flyoutBackdrop, flyoutPanel, flyoutTitle, flyoutClose, flyoutContent;
        // Authentication elements
        let googleSignInBtn, loginError, loginScreen, appContainer, googleSignInBtnDefaultHTML;

        // --- STATE ---
        let fullData = [];
        let ticketsChart = null;
        let agentChart = null;
        let categoryColName = null;
        let lastAnalytics = null;
        let currentAgentName = null;
        let columnMap = {};
        let isDarkMode = localStorage.getItem('isDarkMode') === 'true';

        // --- AUTHENTICATION STATE ---
        let isAuthenticated = false;
        let currentUser = null;

        // Bypass authentication for testing
        function bypassAuthForTesting() {
            isAuthenticated = true;
            currentUser = { email: 'test@example.com', name: 'Test User' };
            showMainContent();
        }

        // Register Chart.js Datalabels plugin if available
        try {
            if (typeof Chart !== 'undefined' && typeof Chart.register === 'function' && typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }
        } catch (e) {
            console.warn('ChartDataLabels plugin not registered:', e);
        }

        // --- UTILITIES ---
        
        // Data processing utilities
        function findColumnName(columns, possibleNames) {
            const lower = columns.map(c => c.toLowerCase());
            for (const pname of possibleNames) {
                const idx = lower.indexOf(pname.toLowerCase());
                if (idx !== -1) return columns[idx];
            }
            return null;
        }
        
        function validateData(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                throw new Error('No data received from API.');
            }
            if (!data[0] || typeof data[0] !== 'object') {
                throw new Error('Invalid data format received from API.');
            }
            return true;
        }

        function safeDate(value) {
            if (!value || typeof value !== 'string') return null;
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            // Allow dates up to 5 years in the future to handle future submissions
            const maxFutureDate = new Date();
            maxFutureDate.setFullYear(maxFutureDate.getFullYear() + 5);

            const parts = String(value).trim().match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
            if (!parts) {
                const fallback = new Date(value);
                return isNaN(fallback.getTime()) || fallback > maxFutureDate ? null : fallback;
            }

            const p1 = parseInt(parts[1], 10);
            const p2 = parseInt(parts[2], 10);
            let year = parseInt(parts[3], 10);
            if (year < 100) year += 2000;

            let dateAsDDMM = null;
            if (p1 > 0 && p1 <= 31 && p2 > 0 && p2 <= 12) {
                const d = new Date(Date.UTC(year, p2 - 1, p1));
                if (!isNaN(d.getTime()) && d <= maxFutureDate) dateAsDDMM = d;
            }

            let dateAsMMDD = null;
            if (p2 > 0 && p2 <= 31 && p1 > 0 && p1 <= 12) {
                const d = new Date(Date.UTC(year, p1 - 1, p2));
                if (!isNaN(d.getTime()) && d <= maxFutureDate) dateAsMMDD = d;
            }

            // Prefer DD/MM format for UK dates, but allow both past and future dates
            if (dateAsDDMM && dateAsMMDD) {
                // If both are valid, prefer DD/MM (UK format)
                return dateAsDDMM;
            } else if (dateAsDDMM) {
                return dateAsDDMM;
            } else if (dateAsMMDD) {
                return dateAsMMDD;
            }
            
            return null;
        }
        
        function formatDuration(ms) {
            if (isNaN(ms) || ms <= 0) return '-';
            const minutes = ms / (1000 * 60);
            if (minutes < 1) return '<1 min';
            if (minutes < 60) {
                const roundedMins = Math.round(minutes);
                return `${roundedMins} min${roundedMins === 1 ? '' : 's'}`;
            }
            const hours = ms / (1000 * 60 * 60);
            if (hours < 24) {
                const roundedHours = parseFloat(hours.toFixed(1));
                return `${roundedHours} hour${roundedHours === 1.0 ? '' : 's'}`;
            }
            const days = ms / (1000 * 60 * 60 * 24);
            const roundedDays = parseFloat(days.toFixed(1));
            return `${roundedDays} day${roundedDays === 1.0 ? '' : 's'}`;
        }

        function isoDay(date) { return date.toISOString().split('T')[0]; }

        function calculateRollingAverage(dailyData, windowSize = 7) {
            const sortedDates = Object.keys(dailyData).sort();
            const rollingAvg = {};
            let sum = 0;
            const window = [];
            for (const date of sortedDates) {
                const value = dailyData[date];
                window.push(value);
                sum += value;
                if (window.length > windowSize) { sum -= window.shift(); }
                rollingAvg[date] = sum / window.length;
            }
            return rollingAvg;
        }

        // Chart utilities
        const CHART_COLORS = ['#4F46E5', '#0EA5E9', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#22D3EE', '#84CC16'];
        const COLOR_MAP = new Map();
        const COLOR_MAP_STORAGE_KEY = 'chart_color_map_v1';
        (function loadColorMap(){
            try {
                const raw = localStorage.getItem(COLOR_MAP_STORAGE_KEY);
                if (raw) {
                    const obj = JSON.parse(raw);
                    Object.keys(obj || {}).forEach(k => COLOR_MAP.set(k, obj[k]));
                }
            } catch (_) {}
        })();
        function persistColorMap(){
            try {
                const obj = {};
                COLOR_MAP.forEach((v, k) => { obj[k] = v; });
                localStorage.setItem(COLOR_MAP_STORAGE_KEY, JSON.stringify(obj));
            } catch (_) {}
        }
        function getStableColor(key, index) {
            const safeKey = String(key || 'unknown');
            if (!COLOR_MAP.has(safeKey)) {
                COLOR_MAP.set(safeKey, CHART_COLORS[index % CHART_COLORS.length]);
                persistColorMap();
            }
            return COLOR_MAP.get(safeKey);
        }
        
        function stringToColor(str, index) { return getStableColor(str || String(index), index); }

        function getPrimarySeriesColors() {
            const isDark = document.documentElement.classList.contains('dark');
            return {
                line: isDark ? '#60A5FA' : '#4F46E5',
                barFill: isDark ? 'rgba(96, 165, 250, 0.15)' : 'rgba(79, 70, 229, 0.1)',
                barBorder: isDark ? 'rgba(96, 165, 250, 0.5)' : 'rgba(79, 70, 229, 0.4)'
            };
        }

        function chartThemeOptions() {
            const isDark = document.documentElement.classList.contains('dark');
            const grid = isDark ? '#374151' : '#E5E7EB';
            const tick = isDark ? '#D1D5DB' : '#374151';
            const tooltipBg = isDark ? '#111827' : '#FFFFFF';
            const tooltipBorder = isDark ? '#374151' : '#D1D5DB';
            const tooltipText = isDark ? '#F3F4F6' : '#111827';
            
            return {
                scales: {
                    x: { grid: { color: grid }, ticks: { color: tick } },
                    y: { grid: { color: grid }, ticks: { color: tick } }
                },
                plugins: {
                    legend: { labels: { color: tick } },
                    tooltip: { 
                        backgroundColor: tooltipBg,
                        titleColor: tooltipText, 
                        bodyColor: tooltipText,
                        borderColor: tooltipBorder
                    }
                }
            };
        }
        
        function destroyChartSafely(chart) {
            if (chart && typeof chart.destroy === 'function') {
                chart.destroy();
            }
        }
        
        // UI utilities
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                element.textContent = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        function showElement(element) {
            if (element) element.classList.remove('hidden');
        }
        
        function hideElement(element) {
            if (element) element.classList.add('hidden');
        }
        
        function toggleElement(element, show) {
            if (!element) return;
            if (show) showElement(element);
            else hideElement(element);
        }

        // --- DATA FETCH + INIT ---
        async function initializeDashboard() {
            try {
                const response = await fetchJsonWithTimeout(API_URL, 15000);
                if (!response.ok) throw new Error(`Network error: ${response.status} ${response.statusText}`);
                const rawData = await response.json();
                validateData(rawData);

                const columns = Object.keys(rawData[0]);
                columnMap = {
                    submitted: findColumnName(columns, DATE_COLUMNS.submitted),
                    started: findColumnName(columns, DATE_COLUMNS.started),
                    completed: findColumnName(columns, DATE_COLUMNS.completed),
                    category: findColumnName(columns, [CATEGORY_COLUMN]),
                    name: findColumnName(columns, [NAME_COLUMN]),
                    account: findColumnName(columns, [DATA_COLUMNS.account]),
                    slack: findColumnName(columns, [DATA_COLUMNS.slack]),
                    status: findColumnName(columns, [STATUS_COLUMN, 'Current Status', 'Ticket Status'])
                };

                if (!columnMap.submitted || !columnMap.started || !columnMap.completed) throw new Error('Missing required date columns.');
                if (!columnMap.category) throw new Error(`Category column '${CATEGORY_COLUMN}' not found.`);
                if (!columnMap.name) throw new Error(`Name column '${NAME_COLUMN}' not found.`);

                categoryColName = columnMap.category;

                fullData = rawData.map((d, index) => {
                    let categoryValue = d[columnMap.category] ? String(d[columnMap.category]).trim() : '';
                    if (categoryValue.toUpperCase().startsWith('DDC')) { categoryValue = 'DDC'; }
                    
                    const rawStatus = columnMap.status ? String(d[columnMap.status] || '').trim() : '';
                    const parsedTicket = {
                        ...d,
                        [columnMap.category]: categoryValue,
                        submittedAt: safeDate(d[columnMap.submitted]),
                        startedAt: safeDate(d[columnMap.started]),
                        completedAt: safeDate(d[columnMap.completed]),
                        statusNormalized: rawStatus.toLowerCase()
                    };
                    
                    // Debug logging for specific problematic account numbers (development only)
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    const account = d[columnMap.account];
                    if (account === 'A-41C8F934' || account === 'A-04690A85') {
                        console.log(` Debug ticket ${account} (row ${index}):`, {
                            rawData: d,
                            parsedSubmittedAt: parsedTicket.submittedAt,
                            parsedStartedAt: parsedTicket.startedAt,
                            parsedCompletedAt: parsedTicket.completedAt
                        });
                        }
                    }
                    
                    return parsedTicket;
                });

                populateCategoryFilter(fullData, columnMap.category);
                refreshAll();
                
                // Hide loader and show dashboard with smooth transition
                console.log(' Data loaded successfully, hiding loader and showing dashboard');
                
                // Add a slight delay for smoother transition
                setTimeout(() => {
                loader.classList.add('hidden');
                dashboard.classList.remove('hidden');
                applyDarkMode();
                    
                    // Trigger entrance animations for cards
                    const cards = document.querySelectorAll('.bg-white');
                    cards.forEach((card, index) => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, index * 100);
                    });
                }, 500);
            } catch (error) {
                console.error('Initialisation error:', error);
                const friendlyMessage = (error && error.name === 'AbortError')
                    ? 'Request timed out. Please refresh and try again.'
                    : (error && error.message) || 'Unexpected error during initialisation.';
                errorMessage.textContent = `Error: ${friendlyMessage}`;
                errorMessage.style.display = 'block';
                if (loader) loader.classList.add('hidden');
            }
        }

        // --- UI BUILDERS ---
        function populateCategoryFilter(data, categoryCol) {
            const categories = [...new Set(data.map(item => item[categoryCol]).filter(Boolean))].sort();
            categoryFilter.innerHTML = `<option value="all">All Sites</option>` +
                categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
        }

        function updateKpiCards(analytics) {
            const metric = getActiveMetric();
            const busiestDayData = analytics.busiestDay[metric];
            const rangeText = dateRangeFilter.value === 'custom' ? 'Custom Range' : dateRangeFilter.options[dateRangeFilter.selectedIndex].text;

            const titleMap = {
                submitted: 'Busiest Day (Total Queries)',
                started: 'Busiest Day (Queries Investigating)',
                completed: 'Busiest Day (Queries Closed)'
            };
            const countTextMap = {
                submitted: 'submitted',
                started: 'started',
                completed: 'closed'
            };
             const totalTicketsTitleMap = {
                submitted: 'Total Queries Submitted',
                started: 'Total Queries Investigating',
                completed: 'Total Queries Closed'
            };

            busiestDayTitle.textContent = titleMap[metric];
            document.getElementById('busiestDay').textContent = busiestDayData.date;
            document.getElementById('busiestDayCount').textContent = busiestDayData.count ? `${busiestDayData.count} ${countTextMap[metric]}` : '';
            
            totalTicketsTitle.textContent = `${totalTicketsTitleMap[metric]} (${rangeText})`;
            animateValue(document.getElementById('totalTickets'), 0, analytics.totalTickets, 500);
            
            animateValue(document.getElementById('unassignedQueries'), 0, analytics.unassignedCount, 500);

            document.getElementById('avgFirstResponse').textContent = formatDuration(analytics.avgFirstResponse);
            document.getElementById('avgResolutionTime').textContent = formatDuration(analytics.avgResolutionTime);
            document.getElementById('avgLifecycle').textContent = formatDuration(analytics.avgLifecycle);
            
            mainChartTitle.textContent = `Category Comparison (${rangeText})`;
            leaderboardTitle.textContent = `Leaderboard (${rangeText})`;
        }

        function renderTicketsByDayChart(analytics, metric = getActiveMetric()) {
            const chartLoading = document.getElementById('chartLoading');
            
            try {
                showElement(chartLoading);
                
                const ctx = document.getElementById('ticketsByDayChart')?.getContext('2d');
                if (!ctx) {
                    console.error('Chart canvas not found');
                    hideElement(chartLoading);
                    return;
                }
                if (!analytics || !analytics.ticketsByDayByCategory) {
                    console.error('Invalid analytics data for chart rendering');
                    hideElement(chartLoading);
                    return;
                }
            const selectedCategory = categoryFilter.value;
            
            const datasets = [];
            const allDates = new Set();
            
            const metricTextMap = {
                submitted: 'new queries submitted',
                started: 'queries being investigated',
                completed: 'queries closed'
            };
            const currentMetricText = metricTextMap[metric];

            let chartType = 'line'; // Default to line chart
            if (selectedCategory === 'all') {
                chartExplanation.innerHTML = `This chart shows the number of <strong>${currentMetricText}</strong> for each site. Each coloured line represents a different site.`;
                const categoryData = analytics.ticketsByDayByCategory;
                const categories = Object.keys(categoryData);
                
                categories.forEach(cat => {
                    Object.keys(categoryData[cat][metric]).forEach(date => allDates.add(date));
                });

                categories.forEach((cat, index) => {
                    const color = stringToColor(cat, index);
                    datasets.push({
                        label: cat,
                        data: Array.from(allDates).sort().map(date => categoryData[cat][metric][date] || 0),
                        borderColor: color,
                        backgroundColor: color + '1A',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 2,
                    });
                });
            } else {
                chartType = 'bar'; // Switch to bar for single category
                chartExplanation.innerHTML = `This view shows the trend for <strong>${selectedCategory}</strong>, counting the number of <strong>${currentMetricText}</strong>. The bars are daily counts, and the line is the 7-day rolling average.`;
                const dailyData = analytics.ticketsByDayByCategory[selectedCategory]?.[metric] || {};
                Object.keys(dailyData).forEach(date => allDates.add(date));
                const rollingAvgData = calculateRollingAverage(dailyData);

                const cols = getPrimarySeriesColors();
                datasets.push({
                    label: `Daily Count`,
                    data: Array.from(allDates).sort().map(day => dailyData[day] || 0),
                    backgroundColor: cols.barFill,
                    borderColor: cols.barBorder,
                });
                datasets.push({
                    label: '7-Day Rolling Average',
                    data: Array.from(allDates).sort().map(day => rollingAvgData[day] || 0),
                    borderColor: cols.line,
                    backgroundColor: 'transparent',
                    type: 'line',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2
                });
            }
            
            const sortedDates = Array.from(allDates).sort();
            const chartData = { labels: sortedDates, datasets };
            const options = { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM d, yyyy', displayFormats: { day: 'MMM d' } }, ticks: { autoSkip: true, maxTicksLimit: 10 } }, y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false }, datalabels: { display: false } } };

            const themed = chartThemeOptions();
            options.scales.x.grid = { color: themed.scales.x.grid.color };
            options.scales.x.ticks.color = themed.scales.x.ticks.color;
            options.scales.y.grid = { color: themed.scales.y.grid.color };
            options.scales.y.ticks.color = themed.scales.y.ticks.color;
            options.plugins.legend.labels = { color: themed.plugins.legend.labels.color };
            
            // Enhanced tooltip styling for better readability
            options.plugins.tooltip = {
                ...options.plugins.tooltip,
                backgroundColor: themed.plugins.tooltip.backgroundColor,
                titleColor: themed.plugins.tooltip.titleColor,
                bodyColor: themed.plugins.tooltip.bodyColor,
                borderColor: themed.plugins.tooltip.borderColor,
                borderWidth: 1,
                cornerRadius: 8,
                titleFont: { weight: 'bold', size: 13 },
                bodyFont: { size: 12 },
                padding: 12
            };

            destroyChartSafely(ticketsChart);
            
            try {
                // For mixed chart types (bar + line), use 'bar' as base type
                const finalChartType = datasets.some(d => d.type === 'line') ? 'bar' : chartType;
                ticketsChart = new Chart(ctx, { type: finalChartType, data: chartData, options });
            } catch (chartError) {
                console.error('Failed to create chart:', chartError);
                const chartContainer = document.getElementById('mainChartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 py-20">Chart rendering failed. Please refresh the page.</div>';
                }
            }
                
                // Hide loading state after chart is rendered
                setTimeout(() => hideElement(chartLoading), 100);
            } catch (error) {
                console.error('Error rendering main chart:', error);
                hideElement(chartLoading);
                const chartContainer = document.getElementById('mainChartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Error loading chart data</div>';
                }
            }
        }

        function renderLeaderboard(agentStats, filter = '') {
            try {
                if (!agentStats || typeof agentStats !== 'object') {
                    leaderboardContainer.innerHTML = `<div class="text-center text-gray-500 py-10">No leaderboard data available.</div>`;
                    return;
                }
                
                const q = (filter || '').toLowerCase();
            const sorted = Object.entries(agentStats)
                    .filter(([name, stats]) => name && stats && name.toLowerCase().includes(q))
                    .sort(([, a], [, b]) => (b.closed || 0) - (a.closed || 0));

            if (sorted.length === 0) {
                    leaderboardContainer.innerHTML = `<div class="text-center text-gray-500 py-10">No agents found for the current filters.</div>`;
                return;
            }

            leaderboardContainer.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4 font-semibold">Rank</th>
                            <th class="p-4 font-semibold">Agent Name</th>
                            <th class="p-4 font-semibold text-right">Queries Closed</th>
                            <th class="p-4 font-semibold text-right">Queries In Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sorted.map(([name, stats], index) => `
                            <tr class="border-b hover:bg-gray-50 cursor-pointer" data-agent-name="${escapeHtml(name)}" tabindex="0" role="button" aria-label="Open ${escapeHtml(name)} performance details">
                                <td class="p-4">${index === 0 ? '<svg class="w-5 h-5 text-yellow-500 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' : index === 1 ? '<svg class="w-5 h-5 text-gray-400 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' : index === 2 ? '<svg class="w-5 h-5 text-amber-600 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' : `<span class="w-5 h-5 inline-flex items-center justify-center text-sm font-semibold text-gray-600 bg-gray-100 rounded-full">${index + 1}</span>`}</td>
                                <td class="p-4 font-medium">${escapeHtml(name)}</td>
                                <td class="p-4 font-bold text-right">${stats.closed}</td>
                                <td class="p-4 text-right">${stats.inProgress}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            } catch (error) {
                console.error('Error rendering leaderboard:', error);
                leaderboardContainer.innerHTML = `<div class="text-center text-red-500 py-10">Error loading leaderboard data</div>`;
            }
        }
        
        function openAgentModal(agentName) {
            currentAgentName = agentName;
            
            const agentModalName = document.getElementById('agentModalName');
            if (agentModalName) {
                agentModalName.textContent = `${agentName}'s Performance`;
            }
            
            if (agentModal) {
                const tablist = agentModal.querySelector('[role="tablist"]');
                if (tablist) {
                    // Ensure all four tabs exist (Summary / In Progress / Weekly / Daily)
                    const ensureTab = (key, label) => {
                        let btn = tablist.querySelector(`[data-tab="${key}"]`);
                        if (!btn) {
                            btn = document.createElement('button');
                            btn.setAttribute('role','tab');
                            btn.className = 'tab-btn px-2 sm:px-4 py-2 font-medium text-sm';
                            btn.dataset.tab = key;
                            btn.textContent = label;
                            tablist.appendChild(btn);
                        }
                        return btn;
                    };
                    const summaryBtn = ensureTab('summary', 'Summary');
                    ensureTab('inProgress', 'In Progress');
                    ensureTab('weekly', 'Weekly');
                    ensureTab('daily', 'Daily');
                    // Reset states
                    tablist.querySelectorAll('[role="tab"]').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-selected', 'false'); });
                    summaryBtn.classList.add('active');
                    summaryBtn.setAttribute('aria-selected', 'true');
                }
            
            updateAgentModalContent(); 
            agentModal.classList.remove('hidden');
                agentModal.style.display = 'flex';
                
                // Focus management for accessibility
                setTimeout(() => {
                    const closeBtn = document.getElementById('closeModal');
                    closeBtn?.focus();
                }, 100);
            }
        }

        function closeAgentModal() {
            if (agentModal) {
                agentModal.style.display = 'none';
                agentModal.classList.add('hidden');
            }
            // Clean up any existing agent chart to avoid stale instances
            try { destroyChartSafely(agentChart); } catch (e) { /* no-op */ }
            currentAgentName = null;
        }

        function renderAgentKpis(analytics) {
            const container = document.getElementById('agentKpis');
            container.innerHTML = `
                <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg text-center border border-gray-200 dark:border-slate-600">
                    <h4 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Tickets (Filtered)</h4>
                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1">${analytics.totalTickets}</p>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg text-center border border-gray-200 dark:border-slate-600">
                    <h4 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Avg. Time to Resolution</h4>
                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1">${formatDuration(analytics.avgResolutionTime)}</p>
                </div>
                <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg text-center border border-gray-200 dark:border-slate-600">
                    <h4 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total In Progress</h4>
                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1">${analytics.agentStats[currentAgentName]?.inProgress || 0}</p>
                </div>
            `;
        }

        function updateAgentModalContent() {
            if (!currentAgentName) return;
            
            const agentDataForSummary = fullData.filter(ticket => ticket[columnMap.name] === currentAgentName);
            const agentDataForCharts = applyFilters().filter(ticket => ticket[columnMap.name] === currentAgentName);
            const agentAnalyticsForKpis = analyseData(agentDataForCharts, fullData);
            renderAgentKpis(agentAnalyticsForKpis);
            
            const activeTabBtn = agentModal.querySelector('.tab-btn.active');
            const activeTab = activeTabBtn ? activeTabBtn.dataset.tab : 'summary';
            const chartContainer = document.getElementById('agentChartContainer');
            const summaryContainer = document.getElementById('agentSummaryContainer');
            const inProgressContainer = document.getElementById('agentInProgressContainer');

            [chartContainer, summaryContainer, inProgressContainer].forEach(c => c.classList.add('hidden'));

            if (activeTab === 'summary') {
                summaryContainer.classList.remove('hidden');
                renderAgentSummary(agentDataForSummary, agentDataForCharts);
            } else if (activeTab === 'inProgress') {
                inProgressContainer.classList.remove('hidden');
                renderAgentInProgressList(agentDataForSummary);
            } else {
                chartContainer.classList.remove('hidden');
                // Ensure canvas exists and is visible before rendering
                let canvas = document.getElementById('agentChart');
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    canvas.id = 'agentChart';
                    canvas.setAttribute('role', 'img');
                    canvas.setAttribute('aria-label', 'Agent performance chart');
                    chartContainer.appendChild(canvas);
                }
                
                // Defer chart creation with multiple frames to ensure DOM is ready
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // Double-check canvas is ready
                        const readyCanvas = document.getElementById('agentChart');
                        if (readyCanvas && readyCanvas.clientWidth > 0 && readyCanvas.clientHeight > 0) {
                    renderAgentChart(agentDataForCharts, activeTab);
                        } else {
                            console.warn('Canvas not ready, retrying chart render...');
                            setTimeout(() => renderAgentChart(agentDataForCharts, activeTab), 200);
                        }
                    });
                });
            }
        }
        
        function renderAgentSummary(cumulativeAgentData, filteredAgentData) {
            const summaryContainer = document.getElementById('agentSummaryContainer');
            const categoryStats = {};

            filteredAgentData.forEach(ticket => {
                const category = ticket[categoryColName] || 'Uncategorized';
                if (!categoryStats[category]) categoryStats[category] = { closed: 0, inProgress: 0 };
                if (ticket.completedAt) categoryStats[category].closed++;
            });

            cumulativeAgentData.forEach(ticket => {
                const category = ticket[categoryColName] || 'Uncategorized';
                if (!categoryStats[category]) categoryStats[category] = { closed: 0, inProgress: 0 };
                if (isTicketInProgress(ticket)) {
                    categoryStats[category].inProgress++;
                }
            });

            const sortedCategories = Object.keys(categoryStats).sort();
            
            if (sortedCategories.length === 0) {
                summaryContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">No activity found for this agent in the selected period.</p>`;
                return;
            }

            summaryContainer.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-gray-50 dark:bg-slate-700 border-b border-gray-200 dark:border-slate-600">
                        <tr>
                            <th class="p-4 font-semibold text-gray-900 dark:text-gray-100">Category</th>
                            <th class="p-4 font-semibold text-right text-gray-900 dark:text-gray-100">Queries Closed (Filtered)</th>
                            <th class="p-4 font-semibold text-right text-gray-900 dark:text-gray-100">Total Queries In Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedCategories.map(category => `
                            <tr class="border-b border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                                <td class="p-4 font-medium text-gray-900 dark:text-gray-100">${escapeHtml(category)}</td>
                                <td class="p-4 text-right text-gray-900 dark:text-gray-100">${categoryStats[category].closed}</td>
                                <td class="p-4 text-right text-gray-900 dark:text-gray-100">${categoryStats[category].inProgress}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderAgentInProgressList(agentData) {
            const container = document.getElementById('agentInProgressContainer');
            const inProgressTickets = agentData
                .filter(t => isTicketInProgress(t))
                .sort((a, b) => (a.submittedAt?.getTime() || 0) - (b.submittedAt?.getTime() || 0));

            if (inProgressTickets.length === 0) {
                container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center py-10">No queries in progress for this agent.</p>`;
                return;
            }
            
            container.innerHTML = inProgressTickets.map(ticket => {
                const account = ticket[columnMap.account] || 'N/A';
                const slack = ticket[columnMap.slack] || '';
                const submitted = ticket.submittedAt ? ticket.submittedAt.toLocaleDateString('en-GB') : 'N/A';
                const submittedIso = ticket.submittedAt ? ticket.submittedAt.toISOString() : '';
                
                // Debug logging for problematic entries (development only)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                if (!ticket.submittedAt) {
                    console.warn(' No submittedAt date for ticket:', {
                        account,
                            rawSubmitted: ticket[columnMap.submitted]
                    });
                    }
                }
                
                return `
                    <div class="border-b border-gray-200 dark:border-slate-600 p-3 grid grid-cols-4 gap-4 items-center hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Account Number</p>
                            <p class="font-medium text-gray-900 dark:text-gray-100">${escapeHtml(account)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Submitted</p>
                            <p class="font-medium text-gray-900 dark:text-gray-100">${submitted}</p>
                        </div>
                        <div>
                            ${slack ? `<a href="${escapeHtml(slack)}" target="_blank" rel="noopener noreferrer" class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full text-sm font-semibold hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors">View on Slack</a>` : ''}
                        </div>
                        <div class="flex justify-end">
                            <button
                                class="flag-btn bg-yellow-100 dark:bg-yellow-200 text-yellow-800 dark:text-yellow-900 px-3 py-1 rounded-full text-sm font-semibold hover:bg-yellow-200 dark:hover:bg-yellow-300 disabled:opacity-60 transition-colors"
                                data-account="${escapeHtml(account)}"
                                data-slack="${escapeHtml(slack)}"
                                data-submitted="${escapeHtml(submittedIso)}"
                                data-debug-info="${escapeHtml(JSON.stringify({account, rawSubmitted: ticket[columnMap.submitted], submittedIso}))}"
                                aria-label="Flag ticket for account ${escapeHtml(account)}"
                            ><svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd"/></svg>Flag</button>
                        </div>
                    </div>
                `;
            }).join('');
        }


        function renderAgentChart(agentData, activeTab) {
            const metric = getActiveMetric();
            const canvas = document.getElementById('agentChart');
            if (!canvas) {
                console.error('agentChart canvas missing');
                return;
            }
            
            // Ensure canvas is properly attached to DOM
            if (!canvas.ownerDocument || !canvas.parentNode) {
                console.error('agentChart canvas not properly attached to DOM');
                return;
            }
            
            // Ensure canvas has dimensions
            if (canvas.clientWidth === 0 || canvas.clientHeight === 0) {
                console.warn('agentChart canvas has zero dimensions, retrying...');
                setTimeout(() => renderAgentChart(agentData, activeTab), 100);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Failed to get 2D context from canvas');
                return;
            }
            const colors = getPrimarySeriesColors();
            let chartType = 'bar';
            let chartData;

            // Development-only logging
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log(' renderAgentChart called with:', { activeTab, metric, agentDataLength: agentData.length });
            }

            const dailyTotals = {};
            agentData.forEach(ticket => {
                const date = ticket[`${metric}At`];
                if(date) {
                    const dayKey = isoDay(date);
                    dailyTotals[dayKey] = (dailyTotals[dayKey] || 0) + 1;
                }
            });

            if (activeTab === 'daily') {
                const sortedDays = Object.entries(dailyTotals).sort((a, b) => new Date(a[0]) - new Date(b[0]));
                chartData = { 
                    labels: sortedDays.map(d => d[0]), 
                    datasets: [{ 
                        data: sortedDays.map(d => d[1]),
                        label: `Daily Tickets by ${metric} Date`,
                        borderColor: colors.line, 
                        backgroundColor: colors.barFill,
                        fill: false,
                        tension: 0.15
                    }] 
                };
            } else if (activeTab === 'weekly') {
                const weeklyTotals = {};
                agentData.forEach(ticket => {
                    const date = ticket[`${metric}At`];
                    if (date) {
                        const weekStart = new Date(date);
                        weekStart.setUTCDate(weekStart.getUTCDate() - weekStart.getUTCDay());
                        const weekKey = isoDay(weekStart);
                        weeklyTotals[weekKey] = (weeklyTotals[weekKey] || 0) + 1;
                    }
                });
                const sortedWeeks = Object.entries(weeklyTotals).sort((a, b) => new Date(a[0]) - new Date(b[0]));
                chartData = { 
                    labels: sortedWeeks.map(d => d[0]), 
                    datasets: [{ 
                        data: sortedWeeks.map(d => d[1]),
                        label: `Weekly Tickets by ${metric} Date`,
                        borderColor: colors.line, 
                        backgroundColor: colors.barFill,
                        fill: false,
                        tension: 0.15
                    }] 
                };
            } else {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.warn(' Unknown activeTab, defaulting to daily view:', activeTab);
                }
                // Default to daily if activeTab is unknown
                const sortedDays = Object.entries(dailyTotals).sort((a, b) => new Date(a[0]) - new Date(b[0]));
                chartData = { 
                    labels: sortedDays.map(d => d[0]), 
                    datasets: [{ 
                        data: sortedDays.map(d => d[1]),
                        label: `Daily Tickets by ${metric} Date`,
                        borderColor: colors.line, 
                        backgroundColor: colors.barFill,
                        fill: false,
                        tension: 0.15
                    }] 
                };
            }

            // Validate chartData before proceeding
            if (!chartData || !chartData.datasets || chartData.datasets.length === 0) {
                console.error(' Invalid chart data generated:', chartData);
                return;
            }
            
            const options = { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    x: { 
                        type: 'time', 
                        time: { 
                            unit: activeTab === 'weekly' ? 'week' : 'day', 
                            tooltipFormat: 'MMM d, yyyy', 
                            displayFormats: { day: 'MMM d', week: 'MMM d' } 
                        } 
                    }, 
                    y: { 
                        beginAtZero: true, 
                        ticks: { precision: 0 } 
                    } 
                }, 
                plugins: { 
                    legend: { display: true },
                    datalabels: { display: false }
                } 
            };

            // Apply theme options
            const themed = chartThemeOptions();
            options.scales.x.grid = { color: themed.scales.x.grid.color };
            // Ensure ticks objects exist before setting colours
            options.scales.x.ticks = { ...(options.scales.x.ticks || {}), color: themed.scales.x.ticks.color };
            options.scales.y.grid = { color: themed.scales.y.grid.color };
            options.scales.y.ticks = { ...(options.scales.y.ticks || {}), color: themed.scales.y.ticks.color };
            options.plugins.legend.labels = { color: themed.plugins.legend.labels.color };
            
            // Enhanced tooltip styling for agent charts
            options.plugins.tooltip = {
                backgroundColor: themed.plugins.tooltip.backgroundColor,
                titleColor: themed.plugins.tooltip.titleColor,
                bodyColor: themed.plugins.tooltip.bodyColor,
                borderColor: themed.plugins.tooltip.borderColor,
                borderWidth: 1,
                cornerRadius: 8,
                titleFont: { weight: 'bold', size: 13 },
                bodyFont: { size: 12 },
                padding: 12
            };
            
            destroyChartSafely(agentChart);
            
            try {
            agentChart = new Chart(ctx, { 
                type: chartType, 
                data: chartData, 
                options 
            });
            } catch (chartError) {
                console.error('Failed to create agent chart:', chartError);
                const chartContainer = document.getElementById('agentChartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 py-20">Chart rendering failed</div>';
                }
            }
        }

        function analyseData(data, fullDataset) {
            const agentStats = {};
            const ticketsByDayByCategory = {};
            const timeDiffs = { firstResponse: [], resolution: [], lifecycle: [] };
            
            data.forEach(ticket => {
                 const name = ticket[columnMap.name];
                if (name && name.toLowerCase() !== 'deactivated') {
                    if (!agentStats[name]) agentStats[name] = { closed: 0, inProgress: 0 };
                    agentStats[name].closed++;
                }
            });
            
            fullDataset.forEach(ticket => {
                const name = ticket[columnMap.name];
                if (name && name.toLowerCase() !== 'deactivated') {
                    if (!agentStats[name]) agentStats[name] = { closed: 0, inProgress: 0 };
                    if (isTicketInProgress(ticket)) agentStats[name].inProgress++;
                }
            });

            for (const ticket of data) {
                const category = ticket[categoryColName];
                if (category) {
                    if (!ticketsByDayByCategory[category]) {
                        ticketsByDayByCategory[category] = { submitted: {}, started: {}, completed: {} };
                    }
                    if (ticket.submittedAt?.getTime()) ticketsByDayByCategory[category].submitted[isoDay(ticket.submittedAt)] = (ticketsByDayByCategory[category].submitted[isoDay(ticket.submittedAt)] || 0) + 1;
                    if (ticket.startedAt?.getTime()) ticketsByDayByCategory[category].started[isoDay(ticket.startedAt)] = (ticketsByDayByCategory[category].started[isoDay(ticket.startedAt)] || 0) + 1;
                    if (ticket.completedAt?.getTime()) ticketsByDayByCategory[category].completed[isoDay(ticket.completedAt)] = (ticketsByDayByCategory[category].completed[isoDay(ticket.completedAt)] || 0) + 1;
                }

                const isDigiops = String(category || '').toLowerCase() === 'digiops';
                const diffFn = (a, b) => isDigiops ? (b - a) : businessMsBetween(a, b);

                if (ticket.startedAt?.getTime() && ticket.submittedAt?.getTime()) timeDiffs.firstResponse.push(diffFn(ticket.submittedAt, ticket.startedAt));
                if (ticket.completedAt?.getTime() && ticket.startedAt?.getTime()) timeDiffs.resolution.push(diffFn(ticket.startedAt, ticket.completedAt));
                if (ticket.completedAt?.getTime() && ticket.submittedAt?.getTime()) timeDiffs.lifecycle.push(diffFn(ticket.submittedAt, ticket.completedAt));
            }

            const overallMetricsByDay = { submitted: {}, started: {}, completed: {} };
            Object.values(ticketsByDayByCategory).forEach(catData => {
                Object.entries(catData.submitted).forEach(([date, count]) => overallMetricsByDay.submitted[date] = (overallMetricsByDay.submitted[date] || 0) + count);
                Object.entries(catData.started).forEach(([date, count]) => overallMetricsByDay.started[date] = (overallMetricsByDay.started[date] || 0) + count);
                Object.entries(catData.completed).forEach(([date, count]) => overallMetricsByDay.completed[date] = (overallMetricsByDay.completed[date] || 0) + count);
            });

            const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
            const findBusiestDay = (dailyData) => Object.entries(dailyData).sort((a, b) => b[1] - a[1])[0];

            const busiestSubmitted = findBusiestDay(overallMetricsByDay.submitted);
            const busiestStarted = findBusiestDay(overallMetricsByDay.started);
            const busiestCompleted = findBusiestDay(overallMetricsByDay.completed);

            const allDays = new Set();
            Object.values(ticketsByDayByCategory).forEach(cat => {
                Object.keys(cat.submitted).forEach(d => allDays.add(d));
                Object.keys(cat.started).forEach(d => allDays.add(d));
                Object.keys(cat.completed).forEach(d => allDays.add(d));
            });

            return {
                totalTickets: data.length, agentStats, ticketsByDayByCategory,
                busiestDay: {
                    submitted: busiestSubmitted ? { date: busiestSubmitted[0], count: busiestSubmitted[1] } : { date: '-', count: 0 },
                    started: busiestStarted ? { date: busiestStarted[0], count: busiestStarted[1] } : { date: '-', count: 0 },
                    completed: busiestCompleted ? { date: busiestCompleted[0], count: busiestCompleted[1] } : { date: '-', count: 0 },
                },
                avgTicketsPerDay: allDays.size > 0 ? (data.length / allDays.size).toFixed(1) : '0.0',
                avgFirstResponse: avg(timeDiffs.firstResponse),
                avgResolutionTime: avg(timeDiffs.resolution),
                avgLifecycle: avg(timeDiffs.lifecycle),
                unassignedCount: fullData.filter(d => d.submittedAt && !d.startedAt && applyFiltersToUnassigned(d)).length
            };
        }
        
        function applyFiltersToUnassigned(ticket) {
            const range = parseInt(dateRangeFilter.value, 10);
            const rangeStart = new Date();
            rangeStart.setUTCHours(0, 0, 0, 0);
            if (range === 365) {
                rangeStart.setUTCMonth(0, 1);
            } else {
                rangeStart.setDate(rangeStart.getDate() - range);
            }
            
            const today = new Date();
            today.setUTCHours(23, 59, 59, 999);
            
            if (!(ticket.submittedAt && ticket.submittedAt >= rangeStart && ticket.submittedAt <= today)) {
                return false;
            }

            const selectedCategory = categoryFilter.value;
            if (selectedCategory !== 'all' && (ticket[categoryColName] || '').toLowerCase() !== selectedCategory.toLowerCase()) {
                return false;
            }
            return true;
        }

        function getActiveMetric() {
            const activeBtn = chartToggle?.querySelector('.active');
            return activeBtn?.dataset?.metric || 'completed';
        }

        function applyFilters() {
            if (!dateRangeFilter || !categoryFilter) {
                console.warn('Filter elements not available');
                return fullData || [];
            }
            const range = dateRangeFilter.value;
            const selectedCategory = categoryFilter.value;
            const metric = getActiveMetric();
            
            let rangeStart, rangeEnd;

            if (range === 'custom') {
                rangeStart = dateFrom.valueAsDate;
                rangeEnd = dateTo.valueAsDate;
                if (rangeStart) rangeStart.setUTCHours(0, 0, 0, 0);
                if (rangeEnd) rangeEnd.setUTCHours(23, 59, 59, 999);
            } else {
                const days = parseInt(range, 10);
                rangeStart = new Date();
                rangeStart.setUTCHours(0, 0, 0, 0);
                if (days === 365) {
                    rangeStart.setUTCMonth(0, 1);
                } else {
                    rangeStart.setDate(rangeStart.getDate() - days);
                }
                rangeEnd = new Date();
                rangeEnd.setUTCHours(23, 59, 59, 999);
            }

            const dateColumn = `${metric}At`;
            
            // Use more efficient filtering approach
            const filtered = fullData.reduce((acc, d) => {
                const date = d[dateColumn];
                if (!date) return acc;
                
                const afterStart = rangeStart ? date >= rangeStart : true;
                const beforeEnd = rangeEnd ? date <= rangeEnd : true;
                if (!afterStart || !beforeEnd) return acc;
            
            if (selectedCategory !== 'all') {
                    const category = (d[categoryColName] || '').toLowerCase();
                    if (category !== selectedCategory.toLowerCase()) return acc;
            }
                
                acc.push(d);
                return acc;
            }, []);
            
            return filtered;
        }

        function refreshAll() {
            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
            const filteredData = applyFilters();
                lastAnalytics = analyseData(filteredData, fullData);
            updateKpiCards(lastAnalytics);
            renderTicketsByDayChart(lastAnalytics);
            renderLeaderboard(lastAnalytics.agentStats, searchInput.value || '');
            });
        }

        function refreshChartOnly() {
            if (!lastAnalytics) return refreshAll();
            renderTicketsByDayChart(lastAnalytics);
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
        }

        // Performance utilities
        function debounce(fn, delay = 200) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }

        function throttle(fn, delay = 100) {
            let lastCall = 0;
            return (...args) => {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    fn(...args);
                }
            };
        }
        
        function memoize(fn) {
            const cache = new Map();
            return (...args) => {
                const key = JSON.stringify(args);
                if (cache.has(key)) {
                    return cache.get(key);
                }
                const result = fn(...args);
                cache.set(key, result);
                return result;
            };
        }

        // Determine if a ticket is currently in progress with robust date handling
        function isValidDate(d) {
            return d instanceof Date && !isNaN(d.getTime());
        }

        function isTicketInProgress(ticket) {
            // 1) Prefer explicit sheet status if available
            const status = (ticket?.statusNormalized || '').trim();
            if (status) {
                const inProgressStatuses = new Set(['in progress', 'investigating', 'started', 'working', 'open - in progress']);
                const closedStatuses = new Set(['closed', 'completed', 'resolved', 'done', 'rejected']);
                if (inProgressStatuses.has(status)) return true;
                if (closedStatuses.has(status)) return false;
                // If status is 'open' or unknown, we fall through to timestamps
            }
            // 2) Fallback to timestamp logic
            const startedAt = ticket?.startedAt;
            const completedAt = ticket?.completedAt;
            if (!isValidDate(startedAt)) return false;
            if (!isValidDate(completedAt)) return true; // no completion date  still in progress
            const now = new Date();
            // If completion is in the future (erroneous/future-dated), treat as still in progress
            if (completedAt > now) return true;
            // Otherwise, completedAt is valid and not in the future  not in progress
            return false;
        }

        // Event listeners moved to DOMContentLoaded

        // CSV download moved to DOMContentLoaded

        function convertToCSV(rows) {
            const headers = new Set();
            rows.forEach(r => Object.keys(r).forEach(k => headers.add(k)));
            const headerList = Array.from(headers);
            const escapeCell = (val) => {
                const s = val == null ? '' : String(val);
                return '"' + s.replace(/"/g, '""') + '"';
            };
            const lines = [];
            lines.push(headerList.join(','));
            rows.forEach(obj => {
                lines.push(headerList.map(h => escapeCell(obj[h] instanceof Date ? obj[h].toISOString() : obj[h])).join(','));
            });
            return lines.join('\n');
        }

        function downloadCsvFromRows(filename, headers, rows) {
            const escapeCell = (val) => '"' + String(val ?? '').replace(/"/g, '""') + '"';
            const lines = [];
            lines.push(headers.map(escapeCell).join(','));
            rows.forEach(r => lines.push(r.map(escapeCell).join(',')));
            const blob = new Blob(["\uFEFF" + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // All event listeners moved to DOMContentLoaded
        const flaggedAccountsThisSession = new Set();

        function applyDarkMode() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                if (darkModeToggle) darkModeToggle.textContent = '';
            } else {
                document.documentElement.classList.remove('dark');
                if (darkModeToggle) darkModeToggle.textContent = '';
            }
        }

        function postJsonWithTimeout(url, body, timeoutMs = 8000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
                signal: controller.signal
            }).finally(() => clearTimeout(timer));
        }
        
        function postSimpleJson(url, body, timeoutMs = 8000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            // Try without explicit Content-Type header to avoid CORS preflight
            return fetch(url, {
                method: 'POST',
                body: JSON.stringify(body),
                signal: controller.signal
            }).finally(() => clearTimeout(timer));
        }

        function postFormNoCors(url, data, timeoutMs = 8000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            const form = new FormData();
            Object.entries(data).forEach(([k, v]) => form.append(k, v == null ? '' : String(v)));
            return fetch(url, { method: 'POST', body: form, mode: 'no-cors', signal: controller.signal })
                .finally(() => clearTimeout(timer));
        }

        // GET helper with timeout to avoid hanging loaders
        function fetchJsonWithTimeout(url, timeoutMs = 15000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            return fetch(url, { signal: controller.signal })
                .finally(() => clearTimeout(timer));
        }

        // Text fetch helper with timeout (for SVG inlining)
        function fetchTextWithTimeout(url, timeoutMs = 15000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            return fetch(url, { signal: controller.signal })
                .finally(() => clearTimeout(timer));
        }

        function businessMsBetween(startDate, endDate) {
            if (!(startDate instanceof Date) || !(endDate instanceof Date)) return 0;
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return 0;
            if (endDate <= startDate) return 0;
            let totalMs = 0;
            const current = new Date(startDate);
            while (current < endDate) {
                const next = new Date(current);
                next.setUTCDate(current.getUTCDate() + 1);
                const day = current.getUTCDay();
                if (day !== 0 && day !== 6) {
                    const from = current;
                    const to = next < endDate ? next : endDate;
                    totalMs += (to - from);
                }
                current.setUTCDate(current.getUTCDate() + 1);
                current.setUTCHours(0, 0, 0, 0);
            }
            return totalMs;
        }


        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize the app
                await initializeApp();
            } catch (error) {
                console.error('Initialization error:', error);
                // Hide loader on error
                const loader = document.getElementById('loader');
                if (loader) loader.classList.add('hidden');
                
                // Show error message
                const errorDiv = document.createElement('div');
                document.body.appendChild(errorDiv);
            }
        });

        async function initializeApp() {
            // Initialize DOM elements
            loader = document.getElementById('loader');
            errorMessage = document.getElementById('errorMessage');
            dashboard = document.getElementById('dashboard');
            searchInput = document.getElementById('searchInput');
            chartToggle = document.getElementById('chartToggle');
            categoryFilter = document.getElementById('categoryFilter');
            dateRangeFilter = document.getElementById('dateRangeFilter');
            agentModal = document.getElementById('agentModal');
            closeModalBtn = document.getElementById('closeModal');
            leaderboardContainer = document.getElementById('leaderboardContainer');
            mainChartTitle = document.getElementById('mainChartTitle');
            chartExplanation = document.getElementById('chartExplanation');
            busiestDayTitle = document.getElementById('busiestDayTitle');
            totalTicketsTitle = document.getElementById('totalTicketsTitle');
            leaderboardTitle = document.getElementById('leaderboardTitle');
            resetFiltersBtn = document.getElementById('resetFiltersBtn');
            customDateRange = document.getElementById('customDateRange');
            dateFrom = document.getElementById('dateFrom');
            dateTo = document.getElementById('dateTo');
            agentInProgressContainer = document.getElementById('agentInProgressContainer');
            downloadCsvBtn = document.getElementById('downloadCsvBtn');
            darkModeToggle = document.getElementById('darkModeToggle');
            flyoutBackdrop = document.getElementById('flyoutBackdrop');
            flyoutPanel = document.getElementById('flyoutPanel');
            flyoutTitle = document.getElementById('flyoutTitle');
            flyoutClose = document.getElementById('flyoutClose');
            flyoutContent = document.getElementById('flyoutContent');
            // Authentication elements
            googleSignInBtn = document.getElementById('googleSignInBtn');
            loginError = document.getElementById('loginError');
            loginScreen = document.getElementById('loginScreen');
            appContainer = document.getElementById('appContainer');
            googleSignInBtnDefaultHTML = googleSignInBtn.innerHTML;

            // Apply theme after elements are ready
            applyTheme();

            // Set up event listeners
            setupEventListeners();
            
            // Initialize dashboard
            await initializeDashboard();
            
            // Handle initial hash
            handleInitialHash();
            
            // Initialize monthly report
            try { 
                initialiseMonthlyReport(); 
            } catch (_) {}
        }

        function applyTheme() {
            isDarkMode = localStorage.getItem('isDarkMode') === 'true';
            applyDarkMode();
        }

        function setupEventListeners() {
            // Dark mode toggle
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    isDarkMode = !isDarkMode;
                    localStorage.setItem('isDarkMode', isDarkMode);
                    applyDarkMode();
                    
                    // Refresh charts to apply new theme
                    if (ticketsChart) refreshChartOnly();
                    if (agentChart && currentAgentName) updateAgentModalContent();
                });
            }

            // DEVELOPMENT MODE: Set to true to bypass authentication for testing
            const DEV_MODE = true;
            
            // Add development mode banner if enabled
            if (DEV_MODE) {
                const devBanner = document.createElement('div');
                devBanner.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #FF6B6B, #4ECDC4); color: white; text-align: center; padding: 8px; font-weight: bold; z-index: 9999; font-family: 'Inter', sans-serif;">
                         DEVELOPMENT MODE - Authentication Bypassed | Set DEV_MODE = false to re-enable
                    </div>
                `;
                document.body.appendChild(devBanner);
            }
            
            if (DEV_MODE) {
                console.log(' DEVELOPMENT MODE: Bypassing authentication');
                // Simulate authenticated user
                currentAgentName = 'Test User';
                if (loginScreen) loginScreen.style.display = 'none';
                if (appContainer) appContainer.classList.remove('hidden');
                initializeDashboard();
                handleInitialHash();
                try { initialiseMonthlyReport(); } catch (_) {}
            } else {
                auth.onAuthStateChanged(user => {
                    console.log('Auth state changed:', user ? 'signed in' : 'signed out');
                    if (user) {
                        console.log('User signed in:', user.email);
                        // Ensure agent name is available for webhook payloads
                        try {
                            currentAgentName = (user && (user.displayName || (user.email ? user.email.split('@')[0] : ''))) || 'Unknown';
                        } catch (_) { currentAgentName = 'Unknown'; }
                        if (loginScreen) loginScreen.style.display = 'none';
                        if (appContainer) appContainer.classList.remove('hidden');
                        initializeDashboard();
                        // Decide initial tab after dashboard init
                        handleInitialHash();
                        // Pre-initialise Monthly tab data in background so it is ready when opened
                        try { initialiseMonthlyReport(); } catch (_) {}
                    } else {
                        console.log('User signed out');
                        try { currentAgentName = null; } catch (_) {}
                        if (loginScreen) loginScreen.style.display = 'flex';
                        if (appContainer) appContainer.classList.add('hidden');
                    }
                });
            }

            // Google sign-in
            function resetGoogleSignInButton() {
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = googleSignInBtnDefaultHTML;
            }
            googleSignInBtn.addEventListener('click', function() {
                if (!auth || !provider) {
                    if (loginError) {
                        loginError.textContent = 'Authentication is not initialised. Please refresh the page.';
                        loginError.classList.remove('hidden');
                    }
                    return;
                }
                googleSignInBtn.disabled = true;
                googleSignInBtn.textContent = 'Signing in...';
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // Domain check
                        if (!result.user.email.endsWith('@' + ORGANISATION_DOMAIN)) {
                            auth.signOut();
                            if (loginError) {
                                loginError.textContent = 'Please sign in with your ' + ORGANISATION_DOMAIN + ' email.';
                                loginError.classList.remove('hidden');
                            }
                            resetGoogleSignInButton();
                        }
                    })
                    .catch((error) => {
                        console.error('Sign-in error:', error);
                        if (loginError) {
                            loginError.textContent = error.message;
                            loginError.classList.remove('hidden');
                        }
                        resetGoogleSignInButton();
                    });
            });

            // === ALL EVENT LISTENERS MOVED HERE ===

            // Search input
            if (searchInput) {
                searchInput.addEventListener('input', debounce(() => {
                    if (!lastAnalytics) return;
                    renderLeaderboard(lastAnalytics.agentStats, searchInput.value);
                }, 150));
            }
            
            // Filter change listeners
            if (categoryFilter) categoryFilter.addEventListener('change', () => {
                refreshAll();
                if (agentModal && agentModal.style.display === 'flex') updateAgentModalContent();
            });
            
            if (dateRangeFilter) {
                dateRangeFilter.addEventListener('change', () => {
                    refreshAll();
                    if (agentModal && agentModal.style.display === 'flex') updateAgentModalContent();
                    const customDates = document.getElementById('flyoutCustomDates');
                    if (customDateRange) customDateRange.classList.toggle('hidden', dateRangeFilter.value !== 'custom');
                    if (customDates) customDates.classList.toggle('hidden', dateRangeFilter.value !== 'custom');
                });
            }
            
            if (dateFrom) dateFrom.addEventListener('change', () => { 
                refreshAll(); 
                if (agentModal && agentModal.style.display === 'flex') updateAgentModalContent(); 
            });
            
            if (dateTo) dateTo.addEventListener('change', () => { 
                refreshAll(); 
                if (agentModal && agentModal.style.display === 'flex') updateAgentModalContent(); 
            });
            
            // Reset filters button
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', () => {
                    resetFiltersBtn.textContent = 'Resetting...';
                    resetFiltersBtn.disabled = true;
                    
                    if (categoryFilter) categoryFilter.value = 'all';
                    if (dateRangeFilter) dateRangeFilter.value = '30';
                    if (searchInput) searchInput.value = '';
                    if (customDateRange) customDateRange.classList.add('hidden');
                    if (dateFrom) dateFrom.value = '';
                    if (dateTo) dateTo.value = '';
                    
                    refreshAll();
                    
                    setTimeout(() => {
                        resetFiltersBtn.textContent = 'Reset Filters';
                        resetFiltersBtn.disabled = false;
                    }, 500);
                });
            }
            
            // Chart toggle
            if (chartToggle) {
                chartToggle.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const metric = e.target.dataset.metric;
                        if (metric) {
                            chartToggle.querySelector('.active')?.classList.remove('active');
                            e.target.classList.add('active');
                            refreshAll();
                            if (agentModal && agentModal.style.display === 'flex') updateAgentModalContent();
                        }
                    }
                });
            }
            
            // Leaderboard events
            if (leaderboardContainer) {
                leaderboardContainer.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (row && row.dataset.agentName) {
                        openAgentModal(row.dataset.agentName);
                    }
                });

                leaderboardContainer.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        const row = e.target.closest('tr');
                        if (row && row.dataset.agentName) {
                            openAgentModal(row.dataset.agentName);
                            e.preventDefault();
                        }
                    }
                });
            }

            // Modal events
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeAgentModal);
            }
            
            if (agentModal) {
                agentModal.addEventListener('click', (e) => {
                    if (e.target === agentModal) closeAgentModal();
                    
                    // Tab switching
                    if (e.target.dataset.tab) {
                        agentModal.querySelectorAll('.tab-btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.setAttribute('aria-selected', 'false');
                        });
                        e.target.classList.add('active');
                        e.target.setAttribute('aria-selected', 'true');
                        updateAgentModalContent();
                    }
                    
                    // Flag button
                    if (e.target.classList.contains('flag-btn')) {
                        const account = e.target.dataset.account;
                        const slack = e.target.dataset.slack;
                        const submitted = e.target.dataset.submitted;
                        
                        if (flaggedAccountsThisSession.has(account)) {
                            alert('This ticket has already been flagged in this session.');
                            return;
                        }
                        
                        e.target.disabled = true;
                        e.target.textContent = 'Flagging...';
                        
                        const payload = {
                            account_number: account,
                            slack_link: slack,
                            submitted_date: submitted,
                            flagged_by: currentUser?.name || 'Unknown',
                            flagged_at: new Date().toISOString()
                        };
                        
                        postFormNoCors(FLAG_WEBHOOK_URL, payload, 8000)
                            .then(() => {
                                flaggedAccountsThisSession.add(account);
                                e.target.textContent = ' Flagged';
                                e.target.classList.remove('bg-yellow-100', 'text-yellow-800', 'hover:bg-yellow-200');
                                e.target.classList.add('bg-green-100', 'text-green-800');
                            })
                            .catch(error => {
                                console.error('Flag webhook error:', error);
                                e.target.disabled = false;
                                e.target.textContent = ' Flag';
                                e.target.classList.remove('bg-yellow-100', 'text-yellow-800');
                                e.target.classList.add('bg-red-100', 'text-red-800');
                            });
                    }
                });
            }
            
            // CSV download
            if (downloadCsvBtn) {
                downloadCsvBtn.addEventListener('click', () => {
                    try {
                        const filteredData = applyFilters();
                        if (!filteredData || filteredData.length === 0) {
                            alert('No data to export with current filters.');
                            return;
                        }
                        
                        const csvContent = convertToCSV(filteredData);
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `smart_hub_data_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (error) {
                        console.error('CSV export error:', error);
                        alert('Error exporting data. Please try again.');
                    }
                });
            }

            // Tab switching
            const tabDashboard = document.getElementById('tabDashboard');
            const tabMonthly = document.getElementById('tabMonthly');
            
            if (tabDashboard) {
                tabDashboard.addEventListener('click', showDashboard);
            }
            
            if (tabMonthly) {
                tabMonthly.addEventListener('click', showMonthly);
            }

            // Flyout events
            if (flyoutBackdrop) flyoutBackdrop.addEventListener('click', closeFlyout);
            if (flyoutClose) flyoutClose.addEventListener('click', closeFlyout);
            
            const flyoutHandle = document.getElementById('flyoutHandle');
            if (flyoutHandle) {
                flyoutHandle.classList.remove('hidden');
                flyoutHandle.addEventListener('click', () => {
                    const isOpen = flyoutPanel && (flyoutPanel.style.transform === 'translateX(0px)' || flyoutPanel.style.transform === 'translateX(0)');
                    if (isOpen) {
                        closeFlyout();
                    } else {
                        openFlyout('Filters');
                    }
                });
            }

            // ESC key handling
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (agentModal && agentModal.style.display === 'flex') {
                        closeAgentModal();
                    } else if (flyoutPanel && !flyoutPanel.classList.contains('hidden')) {
                        closeFlyout();
                    }
                }
            });
        }

        function handleInitialHash() {
            const hash = (location.hash || '').toLowerCase();
            if (hash === '#monthly') {
                showMonthly();
            } else {
                showDashboard();
            }
        }

        function showDashboard() {
            if (dashboard) dashboard.classList.remove('hidden');
            const monthlySection = document.getElementById('monthlyReportSection');
            if (monthlySection) monthlySection.classList.add('hidden');
            
            const tabDashboard = document.getElementById('tabDashboard');
            const tabMonthly = document.getElementById('tabMonthly');
            
            if (tabDashboard) {
                tabDashboard.classList.add('active');
                tabDashboard.setAttribute('aria-selected', 'true');
            }
            if (tabMonthly) {
                tabMonthly.classList.remove('active');
                tabMonthly.setAttribute('aria-selected', 'false');
            }
            
            history.replaceState(null, '', '#dashboard');
        }

        function showMonthly() {
            if (dashboard) dashboard.classList.add('hidden');
            const monthlySection = document.getElementById('monthlyReportSection');
            if (monthlySection) monthlySection.classList.remove('hidden');
            
            const tabDashboard = document.getElementById('tabDashboard');
            const tabMonthly = document.getElementById('tabMonthly');
            
            if (tabDashboard) {
                tabDashboard.classList.remove('active');
                tabDashboard.setAttribute('aria-selected', 'false');
            }
            if (tabMonthly) {
                tabMonthly.classList.add('active');
                tabMonthly.setAttribute('aria-selected', 'true');
            }
            
            history.replaceState(null, '', '#monthly');
            
            // Initialize monthly report if not already done
            if (typeof monthlyInitialised === 'undefined' || !monthlyInitialised) {
                initialiseMonthlyReport();
            }
        }

        function openFlyout(title) {
            if (!flyoutPanel || !flyoutContent || !flyoutBackdrop) return;
            
            try {
                if (flyoutTitle) flyoutTitle.textContent = title || 'Filters';
                
                // Mount controls into flyout slots
                const cat = document.getElementById('categoryFilter');
                const range = document.getElementById('dateRangeFilter');
                const resetBtn = document.getElementById('resetFiltersBtn');
                const csvBtn = document.getElementById('downloadCsvBtn');
                const from = document.getElementById('dateFrom');
                const to = document.getElementById('dateTo');
                
                const catMount = document.getElementById('flyoutCategoryMount');
                const rangeMount = document.getElementById('flyoutRangeMount');
                const resetMount = document.getElementById('flyoutResetMount');
                const csvMount = document.getElementById('flyoutCsvMount');
                const startMount = document.getElementById('flyoutStartMount');
                const endMount = document.getElementById('flyoutEndMount');
                
                if (cat && catMount && !catMount.contains(cat)) catMount.appendChild(cat);
                if (range && rangeMount && !rangeMount.contains(range)) rangeMount.appendChild(range);
                if (resetBtn && resetMount && !resetMount.contains(resetBtn)) resetMount.appendChild(resetBtn);
                if (csvBtn && csvMount && !csvMount.contains(csvBtn)) csvMount.appendChild(csvBtn);
                if (from && startMount && !startMount.contains(from)) startMount.appendChild(from);
                if (to && endMount && !endMount.contains(to)) endMount.appendChild(to);
                
                // Custom dates visibility
                const customDates = document.getElementById('flyoutCustomDates');
                if (customDates) customDates.classList.toggle('hidden', (range?.value || '') !== 'custom');
            } catch (_) {}
            
            flyoutBackdrop.classList.remove('hidden');
            flyoutPanel.classList.remove('hidden');
            flyoutPanel.setAttribute('aria-hidden', 'false');
            
            requestAnimationFrame(() => {
                flyoutPanel.style.transform = 'translateX(0)';
                
                const handle = document.getElementById('flyoutHandle');
                if (handle) {
                    handle.setAttribute('data-open', 'true');
                    handle.setAttribute('aria-label', 'Close filters');
                    handle.title = 'Close filters';
                    
                    const panelWidth = flyoutPanel.getBoundingClientRect().width;
                    handle.style.transition = 'transform 250ms cubic-bezier(0.4, 0, 0.2, 1)';
                    handle.style.transform = `translateY(-50%) translateX(-${Math.min(panelWidth, 420)}px)`;
                    
                    const ico = document.getElementById('flyoutHandleIcon');
                    if (ico) {
                        ico.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';
                        ico.style.transform = 'rotate(180deg)';
                    }
                }
            });
        }

        function closeFlyout() {
            if (!flyoutPanel || !flyoutContent || !flyoutBackdrop) return;
            
            flyoutPanel.style.transform = '';
            flyoutBackdrop.classList.add('hidden');
            flyoutPanel.setAttribute('aria-hidden', 'true');
            
            const handle = document.getElementById('flyoutHandle');
            if (handle) {
                handle.setAttribute('data-open', 'false');
                handle.setAttribute('aria-label', 'Open filters');
                handle.title = 'Open filters';
                handle.style.transition = 'transform 250ms cubic-bezier(0.4, 0, 0.2, 1)';
                handle.style.transform = 'translateY(-50%) translateX(0)';
                
                const ico = document.getElementById('flyoutHandleIcon');
                if (ico) {
                    ico.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';
                    ico.style.transform = 'rotate(0deg)';
                }
            }
            
            setTimeout(() => { 
                flyoutPanel.classList.add('hidden'); 
            }, 250);
        }

        // Monthly report placeholder functions
        function initialiseMonthlyReport() {
            console.log('Monthly report initialization placeholder');
        }

        function monthlyRefresh() {
            console.log('Monthly refresh placeholder');
        }
    </script>
</body>
</html>